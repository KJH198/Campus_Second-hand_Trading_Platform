import{_ as ce,r as g,d as S,c as ue,o as _e,a as fe,b as v,e as o,f as y,w as h,g as me,h as j,t as _,i as W,F as X,j as Z,u as ge,E as a,k as w,l as m,m as L,n as J,p as ve,v as pe,q as ke}from"./index-Bf1IEktR.js";const ye={setup(){const d=ge(),r=ke(),R=g({}),s=g({}),N=g(""),D=g(!1),M=g(d.query.userAvatar||S);function B(e){e.stopPropagation(),D.value=!D.value}function O(e){e.target.closest(".user-profile")||(D.value=!1)}function z(){r.push({name:"UserProfile",query:{user_id:d.query.current_user_id,current_user_id:d.query.current_user_id,userAvatar:d.query.userAvatar,viewing_own_profile:"true"}})}function b(){console.log("查看通知")}function q(){console.log("查看消息")}function Y(){console.log("联系我们")}const A=ue(()=>["已下单","已送达"].includes(s.value.order_state));function p(e){try{const t=atob(e),i=[];for(let l=0;l<t.length;l+=512){const f=t.slice(l,l+512),c=new Array(f.length);for(let x=0;x<f.length;x++)c[x]=f.charCodeAt(x);const E=new Uint8Array(c);i.push(E)}return new Blob(i,{type:"image/jpeg"})}catch(t){return console.error("Error converting base64 to Blob:",t),null}}async function P(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("获取订单详情失败");const t=await e.json();console.log(t),t.success&&(s.value=t.order_detail,console.log(s.value),R.value={...t.goods_detail,goods_pictures:t.goods_detail.goods_pictures.map(i=>{if(i&&typeof i=="string")try{return URL.createObjectURL(p(i))}catch(l){return console.error("Error converting picture:",l),S}return S})},N.value=t.goods_detail.seller_picture?URL.createObjectURL(p(t.goods_detail.seller_picture)):S)}catch(e){console.error("Error fetching order detail:",e),a.error("获取订单详情失败")}}async function U(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("确认送达失败");(await e.json()).success&&(a.success("确认送达成功"),s.value.order_state="已送达")}catch(e){console.error("Error confirming delivery:",e),a.error("确认送达失败")}}async function n(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("申请退款失败");(await e.json()).success&&(a.success("退款申请已提交"),s.value.order_state="已退款")}catch(e){console.error("Error requesting refund:",e),a.error("申请退款失败")}}function u(e){return e||"未知状态"}function G(){r.push({name:"UserProfile",query:{user_id:R.value.seller_id,current_user_id:d.query.current_user_id,userAvatar:N.value,isOwner:!1,viewing_own_profile:"false"}})}const H=g([]),I=g(""),k=g(new Map),T=g(null),C=g(""),V=g(0);async function K(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"comments"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("Failed to fetch comments");const i=(await e.json()).map(l=>{const f={...l,level:1,deliver_picture:l.deliver_picture?URL.createObjectURL(p(l.deliver_picture)):S};return l.reply&&Array.isArray(l.reply)&&(f.reply=l.reply.map(c=>({...c,level:2,deliver_picture:c.deliver_picture?URL.createObjectURL(p(c.deliver_picture)):S}))),f});H.value=i,console.log("评论列表：",H.value)}catch(e){console.error("Error fetching comments:",e),a.error("获取评论失败")}}async function $(){if(!I.value.trim()){a.warning("评论内容不能为空");return}if(!V.value){a.warning("请给出评分");return}try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment:I.value,deliver_id:d.query.current_user_id,order_grade:V.value})});if(!e.ok)throw new Error("Network response was not ok");(await e.json()).success?(a.success("评论发表成功！"),await K(),I.value="",V.value=0):a.error("评论发表失败，请重试")}catch(e){console.error("Error submitting comment:",e),a.error("评论发表失败，请稍后重试")}}function ee(e){T.value===e.goods_comment_id?(T.value=null,C.value=""):(T.value=e.goods_comment_id,C.value="")}async function oe(e){if(!C.value.trim()){a.warning("回复内容不能为空");return}try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_reply"},body:JSON.stringify({goods_comment_id:e,second_goods_comment:C.value,deliver_id:d.query.current_user_id})});if(!t.ok)throw new Error("Network response was not ok");(await t.json()).success?(a.success("回复成功"),C.value="",T.value=null,await K()):a.error("回复失败，请重试")}catch(t){console.error("Error submitting reply:",t),a.error("回复失败，请稍后重试")}}async function te(e){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("点赞失败");const i=await t.json();i.success&&(e.liked=!e.liked,e.likes=i.likes,e.disliked&&(e.disliked=!1,e.dislikes=i.dislikes))}catch(t){console.error("Error liking comment:",t),a.error("点赞失败")}}async function se(e){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("踩失败");const i=await t.json();i.success&&(e.disliked=!e.disliked,e.dislikes=i.dislikes,e.liked&&(e.liked=!1,e.likes=i.likes))}catch(t){console.error("Error disliking comment:",t),a.error("操作失败")}}function re(e){if(!e)return"暂无时间信息";try{const t=new Date(e),l=new Date-t;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分钟前`:l<864e5?`${Math.floor(l/36e5)}小时前`:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(t){return console.error("Error formatting time:",t),"时间格式错误"}}async function ne(e,t){try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_reply"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,reply_id:t.id,user_id:d.query.current_user_id})});if(!i.ok)throw new Error("点赞失败");const l=await i.json();l.success&&(t.liked=!t.liked,t.likes=l.likes,t.disliked&&(t.disliked=!1,t.dislikes=l.dislikes))}catch(i){console.error("Error liking reply:",i),a.error("点赞失败")}}async function ie(e,t){try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_reply"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,reply_id:t.id,user_id:d.query.current_user_id})});if(!i.ok)throw new Error("踩失败");const l=await i.json();l.success&&(t.disliked=!t.disliked,t.dislikes=l.dislikes,t.liked&&(t.liked=!1,t.likes=l.likes))}catch(i){console.error("Error disliking reply:",i),a.error("操作失败")}}function F(e){return e.level===2}function Q(e){return e.level===2?`reply_${e.second_goods_comment_id}`:`comment_${e.goods_comment_id}`}function le(e){const t=Q(e);return k.value.get(t)||null}async function ae(e){const t=Q(e),i=F(e)?2:1,l=F(e)?e.second_goods_comment_id:e.goods_comment_id,f=k.value.get(t);if(f==="like"){try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:i,id:l,cancel:!0})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.helpful-=1,k.value.delete(t),a.success("已取消点赞"))}catch(c){console.error("Error handling like:",c),a.error("操作失败，请稍后重试")}return}if(f==="dislike"){a.warning("您已经点过踩了，如需点赞请先取消点踩");return}try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:i,id:l,cancel:!1})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.helpful+=1,k.value.set(t,"like"),a.success("点赞成功"))}catch(c){console.error("Error handling like:",c),a.error("操作失败，请稍后重试")}}async function de(e){const t=Q(e),i=F(e)?2:1,l=F(e)?e.second_goods_comment_id:e.goods_comment_id,f=k.value.get(t);if(f==="dislike"){try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:i,id:l,cancel:!0})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.unhelpful-=1,k.value.delete(t),a.success("已取消点踩"))}catch(c){console.error("Error handling dislike:",c),a.error("操作失败，请稍后重试")}return}if(f==="like"){a.warning("您已经点过赞了，如需点踩请先取消点赞");return}try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:i,id:l,cancel:!1})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.unhelpful+=1,k.value.set(t,"dislike"),a.success("点踩成功"))}catch(c){console.error("Error handling dislike:",c),a.error("操作失败，请稍后重试")}}return _e(()=>{document.addEventListener("click",O),P(),K()}),fe(()=>{document.removeEventListener("click",O)}),{goodsDetail:R,orderDetail:s,sellerPicture:N,canRequestRefund:A,confirmDelivery:U,requestRefund:n,getOrderStatusText:u,contactSeller:G,comments:H,newComment:I,submitComment:$,toggleReply:ee,likeComment:te,dislikeComment:se,formatTime:re,likeReply:ne,dislikeReply:ie,base64ToBlob:p,toggleDropdown:B,closeDropdown:O,viewProfile:z,viewNotifications:b,viewMessages:q,contactUs:Y,userAvatar:M,commentActions:k,activeReplyId:T,replyContent:C,getCommentAction:le,handleLike:ae,handleDislike:de,submitReply:oe,commentRating:V}}},he={class:"order-details-view"},we={class:"header"},be={class:"nav-container"},Ce={class:"user-section"},Se=["src"],Oe={key:0,class:"dropdown-menu"},Te={class:"good-details"},Ee={class:"good-info"},je={class:"good-images"},Re=["src","alt"],Ne={class:"good-details-info"},De={class:"price"},qe={class:"deal-time"},Ae={class:"seller-info"},Pe=["src"],Ue={class:"order-actions"},Ie={class:"order-status"},Ve={class:"good-description"},Fe={class:"comments-section"},xe={class:"comment-input"},Le={class:"rating-section"},Je={class:"comments-list"},Me={class:"comment-main"},Be=["src"],ze={class:"comment-content"},Ye={class:"comment-header"},Ge={class:"comment-user"},He={class:"comment-rating"},Ke={class:"comment-text"},Qe={class:"comment-footer"},We={class:"comment-time"},Xe={class:"comment-actions"},Ze=["onClick"],$e=["onClick"],eo={class:"count"},oo=["onClick"],to={class:"count"},so={key:0,class:"reply-input-container"},ro={class:"reply-actions"},no=["onClick"],io=["onClick"],lo={key:1,class:"reply-list"},ao=["src"],co={class:"comment-content"},uo={class:"comment-user"},_o={class:"comment-text"},fo={class:"comment-footer"},mo={class:"comment-time"},go={class:"comment-actions"},vo=["onClick"],po={class:"count"},ko=["onClick"],yo={class:"count"};function ho(d,r,R,s,N,D){var A,p,P,U;const M=w("Bell"),B=w("el-icon"),O=w("el-carousel-item"),z=w("el-carousel"),b=w("el-button"),q=w("el-rate"),Y=w("el-input");return m(),v("div",he,[o("header",we,[o("div",be,[r[10]||(r[10]=o("div",{class:"welcome-text"},"欢迎使用二手交易平台",-1)),o("div",Ce,[o("button",{class:"announcement-btn",onClick:r[0]||(r[0]=(...n)=>d.fetchAnnouncements&&d.fetchAnnouncements(...n))},[y(B,null,{default:h(()=>[y(M)]),_:1})]),o("div",{class:"user-profile",onClick:r[6]||(r[6]=me(()=>{},["stop"]))},[o("img",{src:s.userAvatar,alt:"用户头像",class:"avatar",onClick:r[1]||(r[1]=(...n)=>s.toggleDropdown&&s.toggleDropdown(...n))},null,8,Se),d.dropdownVisible?(m(),v("div",Oe,[o("button",{onClick:r[2]||(r[2]=(...n)=>s.viewProfile&&s.viewProfile(...n))},"个人信息"),o("button",{onClick:r[3]||(r[3]=(...n)=>s.viewNotifications&&s.viewNotifications(...n))},"我的通知"),o("button",{onClick:r[4]||(r[4]=(...n)=>s.viewMessages&&s.viewMessages(...n))},"我的消息"),o("button",{onClick:r[5]||(r[5]=(...n)=>s.contactUs&&s.contactUs(...n))},"联系我们")])):j("",!0)])])])]),o("div",Te,[o("div",Ee,[o("div",je,[y(z,{height:"400px"},{default:h(()=>[(m(!0),v(X,null,Z(s.goodsDetail.goods_pictures,(n,u)=>(m(),W(O,{key:u},{default:h(()=>[o("img",{src:n,alt:`商品图片${u+1}`,class:"carousel-image"},null,8,Re)]),_:2},1024))),128))]),_:1})]),o("div",Ne,[o("h1",null,_((A=s.goodsDetail)==null?void 0:A.goods_name),1),o("div",De,"¥"+_((p=s.goodsDetail)==null?void 0:p.goods_price),1),o("div",qe,"下单时间："+_(s.formatTime((P=s.orderDetail)==null?void 0:P.deal_time)),1),o("div",Ae,[o("img",{src:s.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,Pe),y(b,{type:"text",onClick:s.contactSeller},{default:h(()=>r[11]||(r[11]=[L("联系卖家")])),_:1},8,["onClick"])]),o("div",Ue,[o("div",Ie," 订单状态："+_(s.getOrderStatusText(s.orderDetail.order_state)),1),s.orderDetail.order_state==="已下单"?(m(),W(b,{key:0,type:"primary",onClick:s.confirmDelivery},{default:h(()=>r[12]||(r[12]=[L(" 确认送达 ")])),_:1},8,["onClick"])):j("",!0),s.canRequestRefund?(m(),W(b,{key:1,type:"danger",onClick:s.requestRefund},{default:h(()=>r[13]||(r[13]=[L(" 申请退款 ")])),_:1},8,["onClick"])):j("",!0)])])]),o("div",Ve,[r[14]||(r[14]=o("h2",null,"商品描述",-1)),o("p",null,_((U=s.goodsDetail)==null?void 0:U.goods_description),1)]),o("div",Fe,[r[21]||(r[21]=o("h2",null,"评价区",-1)),o("div",xe,[o("div",Le,[r[15]||(r[15]=o("span",{class:"rating-label"},"评分：",-1)),y(q,{modelValue:s.commentRating,"onUpdate:modelValue":r[7]||(r[7]=n=>s.commentRating=n),colors:["#FF9900","#FF9900","#FF9900"],texts:["1星","2星","3星","4星","5星"],"show-text":""},null,8,["modelValue"])]),y(Y,{modelValue:s.newComment,"onUpdate:modelValue":r[8]||(r[8]=n=>s.newComment=n),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),y(b,{type:"primary",onClick:s.submitComment,disabled:!s.newComment.trim()||!s.commentRating},{default:h(()=>r[16]||(r[16]=[L(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),o("div",Je,[(m(!0),v(X,null,Z(s.comments,n=>(m(),v("div",{key:n.goods_comment_id,class:"comment-item"},[o("div",Me,[o("img",{src:n.deliver_picture,alt:"用户头像",class:"comment-avatar"},null,8,Be),o("div",ze,[o("div",Ye,[o("div",Ge,_(n.deliver_name),1),o("div",He,[y(q,{modelValue:n.order_grade,"onUpdate:modelValue":u=>n.order_grade=u,disabled:"","show-score":"","text-color":"#ff9900",colors:["#FF9900","#FF9900","#FF9900"]},null,8,["modelValue","onUpdate:modelValue"])])]),o("div",Ke,_(n.comment),1),o("div",Qe,[o("span",We,_(s.formatTime(n.comment_time)),1),o("div",Xe,[o("button",{class:"action-btn reply-btn",onClick:u=>s.toggleReply(n)},_(s.activeReplyId===n.goods_comment_id?"取消回复":"回复"),9,Ze),o("button",{class:J(["action-btn like-btn",{active:s.getCommentAction(n)==="like"}]),onClick:u=>s.handleLike(n)},[r[17]||(r[17]=o("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),o("span",eo,_(n.helpful),1)],10,$e),o("button",{class:J(["action-btn dislike-btn",{active:s.getCommentAction(n)==="dislike"}]),onClick:u=>s.handleDislike(n)},[r[18]||(r[18]=o("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),o("span",to,_(n.unhelpful),1)],10,oo)])])])]),s.activeReplyId===n.goods_comment_id?(m(),v("div",so,[ve(o("textarea",{"onUpdate:modelValue":r[9]||(r[9]=u=>s.replyContent=u),placeholder:"写下你的回复...",rows:"2",class:"reply-textarea"},null,512),[[pe,s.replyContent]]),o("div",ro,[o("button",{class:"cancel-btn",onClick:u=>s.toggleReply(n)},"取消",8,no),o("button",{class:"submit-btn",onClick:u=>s.submitReply(n.goods_comment_id)},"发送",8,io)])])):j("",!0),n.reply&&n.reply.length>0?(m(),v("div",lo,[(m(!0),v(X,null,Z(n.reply,u=>(m(),v("div",{key:u.second_goods_comment_id,class:"reply-item"},[o("img",{src:u.deliver_picture,alt:"用户头像",class:"comment-avatar"},null,8,ao),o("div",co,[o("div",uo,_(u.deliver_name),1),o("div",_o,_(u.comment),1),o("div",fo,[o("span",mo,_(s.formatTime(u.comment_time)),1),o("div",go,[o("button",{class:J(["action-btn like-btn",{active:s.getCommentAction(u)==="like"}]),onClick:G=>s.handleLike(u)},[r[19]||(r[19]=o("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),o("span",po,_(u.helpful),1)],10,vo),o("button",{class:J(["action-btn dislike-btn",{active:s.getCommentAction(u)==="dislike"}]),onClick:G=>s.handleDislike(u)},[r[20]||(r[20]=o("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),o("span",yo,_(u.unhelpful),1)],10,ko)])])])]))),128))])):j("",!0)]))),128))])])])])}const bo=ce(ye,[["render",ho],["__scopeId","data-v-479caa4f"]]);export{bo as default};
