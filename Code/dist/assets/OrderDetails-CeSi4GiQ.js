import{_ as de,r as k,d as b,c as ce,o as ue,a as _e,b as y,e as t,f as C,w as v,g as fe,h as A,t as _,i as F,F as z,j as Y,u as me,E as d,k as S,l as m,m as I,n as U,p as ke}from"./index-DbkHyC3e.js";const pe={setup(){const l=me(),r=ke(),j=k({}),s=k({}),N=k(""),R=k(!1),J=k(l.query.userAvatar||b);function L(e){e.stopPropagation(),R.value=!R.value}function O(e){e.target.closest(".user-profile")||(R.value=!1)}function M(){r.push({name:"UserProfile",query:{user_id:l.query.current_user_id,current_user_id:l.query.current_user_id,userAvatar:l.query.userAvatar,viewing_own_profile:"true"}})}function g(){console.log("查看通知")}function x(){console.log("查看消息")}function i(){console.log("联系我们")}const u=ce(()=>["已下单","已送达"].includes(s.value.order_state));function h(e){try{const o=atob(e),n=[];for(let a=0;a<o.length;a+=512){const f=o.slice(a,a+512),c=new Array(f.length);for(let D=0;D<f.length;D++)c[D]=f.charCodeAt(D);const E=new Uint8Array(c);n.push(E)}return new Blob(n,{type:"image/jpeg"})}catch(o){return console.error("Error converting base64 to Blob:",o),null}}async function K(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:l.params.orderId,user_id:l.query.current_user_id})});if(!e.ok)throw new Error("获取订单详情失败");const o=await e.json();o.success&&(s.value=o.order_detail,j.value={...o.goods_detail,goods_pictures:o.goods_detail.goods_pictures.map(n=>{if(n&&typeof n=="string")try{return URL.createObjectURL(h(n))}catch(a){return console.error("Error converting picture:",a),b}return b})},N.value=o.goods_detail.seller_picture?URL.createObjectURL(h(o.goods_detail.seller_picture)):b)}catch(e){console.error("Error fetching order detail:",e),d.error("获取订单详情失败")}}async function Q(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:l.params.orderId,user_id:l.query.current_user_id})});if(!e.ok)throw new Error("确认送达失败");(await e.json()).success&&(d.success("确认送达成功"),s.value.order_state="已送达")}catch(e){console.error("Error confirming delivery:",e),d.error("确认送达失败")}}async function W(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:l.params.orderId,user_id:l.query.current_user_id})});if(!e.ok)throw new Error("申请退款失败");(await e.json()).success&&(d.success("退款申请已提交"),s.value.order_state="已退款")}catch(e){console.error("Error requesting refund:",e),d.error("申请退款失败")}}function X(e){return e||"未知状态"}function Z(){r.push({name:"UserProfile",query:{user_id:j.value.seller_id,current_user_id:l.query.current_user_id,userAvatar:N.value,isOwner:!1,viewing_own_profile:"false"}})}const G=k([]),P=k(""),p=k(new Map),T=k(null),w=k("");async function B(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"comments"},body:JSON.stringify({goods_id:l.params.orderId,user_id:l.query.current_user_id})});if(!e.ok)throw new Error("Failed to fetch comments");const n=(await e.json()).map(a=>{const f={...a,level:1,deliver_picture:a.deliver_picture?URL.createObjectURL(h(a.deliver_picture)):b};return a.reply&&Array.isArray(a.reply)&&(f.reply=a.reply.map(c=>({...c,level:2,deliver_picture:c.deliver_picture?URL.createObjectURL(h(c.deliver_picture)):b}))),f});G.value=n}catch(e){console.error("Error fetching comments:",e),d.error("获取评论失败")}}async function $(){if(!P.value.trim()){d.warning("评论内容不能为空");return}try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_comment"},body:JSON.stringify({goods_id:l.params.orderId,comment:P.value,deliver_id:l.query.current_user_id})});if(!e.ok)throw new Error("Network response was not ok");(await e.json()).success?(d.success("评论发表成功！"),await B(),P.value=""):d.error("评论发表失败，请重试")}catch(e){console.error("Error submitting comment:",e),d.error("评论发表失败，请稍后重试")}}function ee(e){T.value===e.goods_comment_id?(T.value=null,w.value=""):(T.value=e.goods_comment_id,w.value="")}async function H(e){if(!w.value.trim()){d.warning("回复内容不能为空");return}try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_reply"},body:JSON.stringify({goods_comment_id:e,second_goods_comment:w.value,deliver_id:l.query.current_user_id})});if(!o.ok)throw new Error("Network response was not ok");(await o.json()).success?(d.success("回复成功"),w.value="",T.value=null,await B()):d.error("回复失败，请重试")}catch(o){console.error("Error submitting reply:",o),d.error("回复失败，请稍后重试")}}async function oe(e){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_comment"},body:JSON.stringify({goods_id:l.params.orderId,comment_id:e.id,user_id:l.query.current_user_id})});if(!o.ok)throw new Error("点赞失败");const n=await o.json();n.success&&(e.liked=!e.liked,e.likes=n.likes,e.disliked&&(e.disliked=!1,e.dislikes=n.dislikes))}catch(o){console.error("Error liking comment:",o),d.error("点赞失败")}}async function te(e){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_comment"},body:JSON.stringify({goods_id:l.params.orderId,comment_id:e.id,user_id:l.query.current_user_id})});if(!o.ok)throw new Error("踩失败");const n=await o.json();n.success&&(e.disliked=!e.disliked,e.dislikes=n.dislikes,e.liked&&(e.liked=!1,e.likes=n.likes))}catch(o){console.error("Error disliking comment:",o),d.error("操作失败")}}function se(e){const o=new Date(e),a=new Date-o;return a<6e4?"刚刚":a<36e5?`${Math.floor(a/6e4)}分钟前`:a<864e5?`${Math.floor(a/36e5)}小时前`:`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`}async function re(e,o){try{const n=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_reply"},body:JSON.stringify({goods_id:l.params.orderId,comment_id:e.id,reply_id:o.id,user_id:l.query.current_user_id})});if(!n.ok)throw new Error("点赞失败");const a=await n.json();a.success&&(o.liked=!o.liked,o.likes=a.likes,o.disliked&&(o.disliked=!1,o.dislikes=a.dislikes))}catch(n){console.error("Error liking reply:",n),d.error("点赞失败")}}async function ie(e,o){try{const n=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_reply"},body:JSON.stringify({goods_id:l.params.orderId,comment_id:e.id,reply_id:o.id,user_id:l.query.current_user_id})});if(!n.ok)throw new Error("踩失败");const a=await n.json();a.success&&(o.disliked=!o.disliked,o.dislikes=a.dislikes,o.liked&&(o.liked=!1,o.likes=a.likes))}catch(n){console.error("Error disliking reply:",n),d.error("操作失败")}}function q(e){return e.level===2}function V(e){return e.level===2?`reply_${e.second_goods_comment_id}`:`comment_${e.goods_comment_id}`}function ne(e){const o=V(e);return p.value.get(o)||null}async function ae(e){const o=V(e),n=q(e)?2:1,a=q(e)?e.second_goods_comment_id:e.goods_comment_id,f=p.value.get(o);if(f==="like"){try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:n,id:a,cancel:!0})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.helpful-=1,p.value.delete(o),d.success("已取消点赞"))}catch(c){console.error("Error handling like:",c),d.error("操作失败，请稍后重试")}return}if(f==="dislike"){d.warning("您已经点过踩了，如需点赞请先取消点踩");return}try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:n,id:a,cancel:!1})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.helpful+=1,p.value.set(o,"like"),d.success("点赞成功"))}catch(c){console.error("Error handling like:",c),d.error("操作失败，请稍后重试")}}async function le(e){const o=V(e),n=q(e)?2:1,a=q(e)?e.second_goods_comment_id:e.goods_comment_id,f=p.value.get(o);if(f==="dislike"){try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:n,id:a,cancel:!0})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.unhelpful-=1,p.value.delete(o),d.success("已取消点踩"))}catch(c){console.error("Error handling dislike:",c),d.error("操作失败，请稍后重试")}return}if(f==="like"){d.warning("您已经点过赞了，如需点踩请先取消点赞");return}try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:n,id:a,cancel:!1})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.unhelpful+=1,p.value.set(o,"dislike"),d.success("点踩成功"))}catch(c){console.error("Error handling dislike:",c),d.error("操作失败，请稍后重试")}}return ue(()=>{document.addEventListener("click",O),K(),B()}),_e(()=>{document.removeEventListener("click",O)}),{goodsDetail:j,orderDetail:s,sellerPicture:N,canRequestRefund:u,confirmDelivery:Q,requestRefund:W,getOrderStatusText:X,contactSeller:Z,comments:G,newComment:P,submitComment:$,toggleReply:ee,submitReply:H,likeComment:oe,dislikeComment:te,formatTime:se,likeReply:re,dislikeReply:ie,base64ToBlob:h,toggleDropdown:L,closeDropdown:O,viewProfile:M,viewNotifications:g,viewMessages:x,contactUs:i,userAvatar:J,commentActions:p,activeReplyId:T,replyContent:w,getCommentAction:ne,handleLike:ae,handleDislike:le,handleReply,submitReply:H}}},ye={class:"order-details-view"},he={class:"header"},ve={class:"nav-container"},ge={class:"user-section"},we=["src"],be={key:0,class:"dropdown-menu"},Ce={class:"good-details"},Se={class:"good-info"},Oe={class:"good-images"},Te=["src","alt"],Ee={class:"good-details-info"},je={class:"price"},Ne={class:"deal-time"},Re={class:"seller-info"},Pe=["src"],qe={class:"order-actions"},De={class:"order-status"},Ae={class:"good-description"},Ie={class:"comments-section"},Ue={class:"comment-input"},Je={class:"comments-list"},Le={class:"comment-main"},Me=["src"],xe={class:"comment-content"},Be={class:"comment-user"},Ve={class:"comment-text"},Fe={class:"comment-footer"},ze={class:"comment-time"},Ye={class:"comment-actions"},Ge=["onClick"],He=["onClick"],Ke={class:"count"},Qe=["onClick"],We={class:"count"},Xe={key:0,class:"reply-list"},Ze=["src"],$e={class:"comment-content"},eo={class:"comment-user"},oo={class:"comment-text"},to={class:"comment-footer"},so={class:"comment-time"},ro={class:"comment-actions"},io=["onClick"],no={class:"count"},ao=["onClick"],lo={class:"count"};function co(l,r,j,s,N,R){const J=S("Bell"),L=S("el-icon"),O=S("el-carousel-item"),M=S("el-carousel"),g=S("el-button"),x=S("el-input");return m(),y("div",ye,[t("header",he,[t("div",ve,[r[8]||(r[8]=t("div",{class:"welcome-text"},"欢迎使用二手交易平台",-1)),t("div",ge,[t("button",{class:"announcement-btn",onClick:r[0]||(r[0]=(...i)=>l.fetchAnnouncements&&l.fetchAnnouncements(...i))},[C(L,null,{default:v(()=>[C(J)]),_:1})]),t("div",{class:"user-profile",onClick:r[6]||(r[6]=fe(()=>{},["stop"]))},[t("img",{src:s.userAvatar,alt:"用户头像",class:"avatar",onClick:r[1]||(r[1]=(...i)=>s.toggleDropdown&&s.toggleDropdown(...i))},null,8,we),l.dropdownVisible?(m(),y("div",be,[t("button",{onClick:r[2]||(r[2]=(...i)=>s.viewProfile&&s.viewProfile(...i))},"个人信息"),t("button",{onClick:r[3]||(r[3]=(...i)=>s.viewNotifications&&s.viewNotifications(...i))},"我的通知"),t("button",{onClick:r[4]||(r[4]=(...i)=>s.viewMessages&&s.viewMessages(...i))},"我的消息"),t("button",{onClick:r[5]||(r[5]=(...i)=>s.contactUs&&s.contactUs(...i))},"联系我们")])):A("",!0)])])])]),t("div",Ce,[t("div",Se,[t("div",Oe,[C(M,{height:"400px"},{default:v(()=>[(m(!0),y(z,null,Y(s.goodsDetail.goods_pictures,(i,u)=>(m(),F(O,{key:u},{default:v(()=>[t("img",{src:i,alt:`商品图片${u+1}`,class:"carousel-image"},null,8,Te)]),_:2},1024))),128))]),_:1})]),t("div",Ee,[t("h1",null,_(s.goodsDetail.goods_name),1),t("div",je,"¥"+_(s.goodsDetail.goods_price),1),t("div",Ne,"下单时间："+_(s.formatTime(s.orderDetail.deal_time)),1),t("div",Re,[t("img",{src:s.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,Pe),C(g,{type:"text",onClick:s.contactSeller},{default:v(()=>r[9]||(r[9]=[I("联系卖家")])),_:1},8,["onClick"])]),t("div",qe,[t("div",De," 订单状态："+_(s.getOrderStatusText(s.orderDetail.order_state)),1),s.orderDetail.order_state==="已下单"?(m(),F(g,{key:0,type:"primary",onClick:s.confirmDelivery},{default:v(()=>r[10]||(r[10]=[I(" 确认送达 ")])),_:1},8,["onClick"])):A("",!0),s.canRequestRefund?(m(),F(g,{key:1,type:"danger",onClick:s.requestRefund},{default:v(()=>r[11]||(r[11]=[I(" 申请退款 ")])),_:1},8,["onClick"])):A("",!0)])])]),t("div",Ae,[r[12]||(r[12]=t("h2",null,"商品描述",-1)),t("p",null,_(s.goodsDetail.goods_description),1)]),t("div",Ie,[r[18]||(r[18]=t("h2",null,"评价区",-1)),t("div",Ue,[C(x,{modelValue:s.newComment,"onUpdate:modelValue":r[7]||(r[7]=i=>s.newComment=i),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),C(g,{type:"primary",onClick:s.submitComment,disabled:!s.newComment.trim()},{default:v(()=>r[13]||(r[13]=[I(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),t("div",Je,[(m(!0),y(z,null,Y(s.comments,i=>(m(),y("div",{key:i.id,class:"comment-item"},[t("div",Le,[t("img",{src:i.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,Me),t("div",xe,[t("div",Be,_(i.username),1),t("div",Ve,_(i.content),1),t("div",Fe,[t("span",ze,_(s.formatTime(i.create_time)),1),t("div",Ye,[t("button",{class:"action-btn reply-btn",onClick:u=>s.toggleReply(i)},_(i.showReply?"取消回复":"回复"),9,Ge),t("button",{class:U(["action-btn like-btn",{active:s.getCommentAction(i)==="like"}]),onClick:u=>s.handleLike(i)},[r[14]||(r[14]=t("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),t("span",Ke,_(i.helpful),1)],10,He),t("button",{class:U(["action-btn dislike-btn",{active:s.getCommentAction(i)==="dislike"}]),onClick:u=>s.handleDislike(i)},[r[15]||(r[15]=t("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),t("span",We,_(i.dislikes),1)],10,Qe)])])])]),i.replies&&i.replies.length>0?(m(),y("div",Xe,[(m(!0),y(z,null,Y(i.replies,u=>(m(),y("div",{key:u.id,class:"reply-item"},[t("img",{src:u.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,Ze),t("div",$e,[t("div",eo,_(u.username),1),t("div",oo,_(u.content),1),t("div",to,[t("span",so,_(s.formatTime(u.create_time)),1),t("div",ro,[t("button",{class:U(["action-btn like-btn",{active:u.liked}]),onClick:h=>s.likeReply(i,u)},[r[16]||(r[16]=t("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),t("span",no,_(u.likes),1)],10,io),t("button",{class:U(["action-btn dislike-btn",{active:u.disliked}]),onClick:h=>s.dislikeReply(i,u)},[r[17]||(r[17]=t("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),t("span",lo,_(u.dislikes),1)],10,ao)])])])]))),128))])):A("",!0)]))),128))])])])])}const _o=de(pe,[["render",co],["__scopeId","data-v-1208dd66"]]);export{_o as default};
