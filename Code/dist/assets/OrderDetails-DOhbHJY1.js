import{_ as te,r as y,d as h,c as oe,o as se,a as re,b as f,e as t,f as g,w as k,g as ie,h as T,t as c,i as I,F as L,j as J,u as ne,E as u,k as v,l as _,m as E,n as j,p as ae}from"./index-DQ4ZzEx_.js";const de={setup(){const a=ne(),r=ae(),b=y({}),s=y({}),C=y(""),O=y(!1),q=y(a.query.userAvatar||h);function D(e){e.stopPropagation(),O.value=!O.value}function w(e){e.target.closest(".user-profile")||(O.value=!1)}function P(){r.push({name:"UserProfile",query:{user_id:a.query.current_user_id,current_user_id:a.query.current_user_id,userAvatar:a.query.userAvatar,viewing_own_profile:"true"}})}function p(){console.log("查看通知")}function N(){console.log("查看消息")}function i(){console.log("联系我们")}const l=oe(()=>["已下单","已送达"].includes(s.value.order_state));function m(e){try{const o=atob(e),n=[];for(let d=0;d<o.length;d+=512){const A=o.slice(d,d+512),B=new Array(A.length);for(let R=0;R<A.length;R++)B[R]=A.charCodeAt(R);const ee=new Uint8Array(B);n.push(ee)}return new Blob(n,{type:"image/jpeg"})}catch(o){return console.error("Error converting base64 to Blob:",o),null}}async function M(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id})});if(!e.ok)throw new Error("获取订单详情失败");const o=await e.json();o.success&&(s.value=o.order_detail,b.value={...o.goods_detail,goods_pictures:o.goods_detail.goods_pictures.map(n=>{if(n&&typeof n=="string")try{return URL.createObjectURL(m(n))}catch(d){return console.error("Error converting picture:",d),h}return h})},C.value=o.goods_detail.seller_picture?URL.createObjectURL(m(o.goods_detail.seller_picture)):h)}catch(e){console.error("Error fetching order detail:",e),u.error("获取订单详情失败")}}async function V(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id})});if(!e.ok)throw new Error("确认送达失败");(await e.json()).success&&(u.success("确认送达成功"),s.value.order_state="已送达")}catch(e){console.error("Error confirming delivery:",e),u.error("确认送达失败")}}async function F(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id})});if(!e.ok)throw new Error("申请退款失败");(await e.json()).success&&(u.success("退款申请已提交"),s.value.order_state="已退款")}catch(e){console.error("Error requesting refund:",e),u.error("申请退款失败")}}function z(e){return e||"未知状态"}function Y(){r.push({name:"UserProfile",query:{user_id:b.value.seller_id,current_user_id:a.query.current_user_id,userAvatar:C.value,isOwner:!1,viewing_own_profile:"false"}})}const x=y([]),S=y("");async function U(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_comments"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id})});if(!e.ok)throw new Error("获取评论失败");const o=await e.json();o.success&&(x.value=o.comments.map(n=>({...n,showReply:!1,replyContent:"",user_avatar:n.user_avatar?URL.createObjectURL(m(n.user_avatar)):h,replies:n.replies.map(d=>({...d,user_avatar:d.user_avatar?URL.createObjectURL(m(d.user_avatar)):h}))})))}catch(e){console.error("Error fetching comments:",e),u.error("获取评论失败")}}async function G(){if(S.value.trim())try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"add_comment"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id,content:S.value})});if(!e.ok)throw new Error("发表评论失败");(await e.json()).success&&(u.success("评论发表成功"),S.value="",await U())}catch(e){console.error("Error submitting comment:",e),u.error("评论发表失败")}}function H(e){e.showReply=!e.showReply}async function K(e){if(e.replyContent.trim())try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"add_reply"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,user_id:a.query.current_user_id,content:e.replyContent})});if(!o.ok)throw new Error("回复评论失败");(await o.json()).success&&(u.success("回复成功"),e.replyContent="",e.showReply=!1,await U())}catch(o){console.error("Error submitting reply:",o),u.error("回复失败")}}async function Q(e){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_comment"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,user_id:a.query.current_user_id})});if(!o.ok)throw new Error("点赞失败");const n=await o.json();n.success&&(e.liked=!e.liked,e.likes=n.likes,e.disliked&&(e.disliked=!1,e.dislikes=n.dislikes))}catch(o){console.error("Error liking comment:",o),u.error("点赞失败")}}async function W(e){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_comment"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,user_id:a.query.current_user_id})});if(!o.ok)throw new Error("踩失败");const n=await o.json();n.success&&(e.disliked=!e.disliked,e.dislikes=n.dislikes,e.liked&&(e.liked=!1,e.likes=n.likes))}catch(o){console.error("Error disliking comment:",o),u.error("操作失败")}}function X(e){const o=new Date(e),d=new Date-o;return d<6e4?"刚刚":d<36e5?`${Math.floor(d/6e4)}分钟前`:d<864e5?`${Math.floor(d/36e5)}小时前`:`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`}async function Z(e,o){try{const n=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_reply"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,reply_id:o.id,user_id:a.query.current_user_id})});if(!n.ok)throw new Error("点赞失败");const d=await n.json();d.success&&(o.liked=!o.liked,o.likes=d.likes,o.disliked&&(o.disliked=!1,o.dislikes=d.dislikes))}catch(n){console.error("Error liking reply:",n),u.error("点赞失败")}}async function $(e,o){try{const n=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_reply"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,reply_id:o.id,user_id:a.query.current_user_id})});if(!n.ok)throw new Error("踩失败");const d=await n.json();d.success&&(o.disliked=!o.disliked,o.dislikes=d.dislikes,o.liked&&(o.liked=!1,o.likes=d.likes))}catch(n){console.error("Error disliking reply:",n),u.error("操作失败")}}return se(()=>{document.addEventListener("click",w),M(),U()}),re(()=>{document.removeEventListener("click",w)}),{goodsDetail:b,orderDetail:s,sellerPicture:C,canRequestRefund:l,confirmDelivery:V,requestRefund:F,getOrderStatusText:z,contactSeller:Y,comments:x,newComment:S,submitComment:G,toggleReply:H,submitReply:K,likeComment:Q,dislikeComment:W,formatTime:X,likeReply:Z,dislikeReply:$,base64ToBlob:m,toggleDropdown:D,closeDropdown:w,viewProfile:P,viewNotifications:p,viewMessages:N,contactUs:i,userAvatar:q}}},le={class:"order-details-view"},ce={class:"header"},ue={class:"nav-container"},_e={class:"user-section"},fe=["src"],me={key:0,class:"dropdown-menu"},ye={class:"good-details"},ke={class:"good-info"},pe={class:"good-images"},he=["src","alt"],ge={class:"good-details-info"},ve={class:"price"},we={class:"deal-time"},be={class:"seller-info"},Ce=["src"],Oe={class:"order-actions"},Se={class:"order-status"},Re={class:"good-description"},Te={class:"comments-section"},Ee={class:"comment-input"},je={class:"comments-list"},qe={class:"comment-main"},De=["src"],Pe={class:"comment-content"},Ne={class:"comment-user"},Ue={class:"comment-text"},Ae={class:"comment-footer"},Ie={class:"comment-time"},Le={class:"comment-actions"},Je=["onClick"],xe=["onClick"],Be={class:"count"},Me=["onClick"],Ve={class:"count"},Fe={key:0,class:"reply-list"},ze=["src"],Ye={class:"comment-content"},Ge={class:"comment-user"},He={class:"comment-text"},Ke={class:"comment-footer"},Qe={class:"comment-time"},We={class:"comment-actions"},Xe=["onClick"],Ze={class:"count"},$e=["onClick"],et={class:"count"};function tt(a,r,b,s,C,O){const q=v("Bell"),D=v("el-icon"),w=v("el-carousel-item"),P=v("el-carousel"),p=v("el-button"),N=v("el-input");return _(),f("div",le,[t("header",ce,[t("div",ue,[r[8]||(r[8]=t("div",{class:"welcome-text"},"欢迎使用二手交易平台",-1)),t("div",_e,[t("button",{class:"announcement-btn",onClick:r[0]||(r[0]=(...i)=>a.fetchAnnouncements&&a.fetchAnnouncements(...i))},[g(D,null,{default:k(()=>[g(q)]),_:1})]),t("div",{class:"user-profile",onClick:r[6]||(r[6]=ie(()=>{},["stop"]))},[t("img",{src:s.userAvatar,alt:"用户头像",class:"avatar",onClick:r[1]||(r[1]=(...i)=>s.toggleDropdown&&s.toggleDropdown(...i))},null,8,fe),a.dropdownVisible?(_(),f("div",me,[t("button",{onClick:r[2]||(r[2]=(...i)=>s.viewProfile&&s.viewProfile(...i))},"个人信息"),t("button",{onClick:r[3]||(r[3]=(...i)=>s.viewNotifications&&s.viewNotifications(...i))},"我的通知"),t("button",{onClick:r[4]||(r[4]=(...i)=>s.viewMessages&&s.viewMessages(...i))},"我的消息"),t("button",{onClick:r[5]||(r[5]=(...i)=>s.contactUs&&s.contactUs(...i))},"联系我们")])):T("",!0)])])])]),t("div",ye,[t("div",ke,[t("div",pe,[g(P,{height:"400px"},{default:k(()=>[(_(!0),f(L,null,J(s.goodsDetail.goods_pictures,(i,l)=>(_(),I(w,{key:l},{default:k(()=>[t("img",{src:i,alt:`商品图片${l+1}`,class:"carousel-image"},null,8,he)]),_:2},1024))),128))]),_:1})]),t("div",ge,[t("h1",null,c(s.goodsDetail.goods_name),1),t("div",ve,"¥"+c(s.goodsDetail.goods_price),1),t("div",we,"下单时间："+c(s.formatTime(s.orderDetail.deal_time)),1),t("div",be,[t("img",{src:s.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,Ce),g(p,{type:"text",onClick:s.contactSeller},{default:k(()=>r[9]||(r[9]=[E("联系卖家")])),_:1},8,["onClick"])]),t("div",Oe,[t("div",Se," 订单状态："+c(s.getOrderStatusText(s.orderDetail.order_state)),1),s.orderDetail.order_state==="已下单"?(_(),I(p,{key:0,type:"primary",onClick:s.confirmDelivery},{default:k(()=>r[10]||(r[10]=[E(" 确认送达 ")])),_:1},8,["onClick"])):T("",!0),s.canRequestRefund?(_(),I(p,{key:1,type:"danger",onClick:s.requestRefund},{default:k(()=>r[11]||(r[11]=[E(" 申请退款 ")])),_:1},8,["onClick"])):T("",!0)])])]),t("div",Re,[r[12]||(r[12]=t("h2",null,"商品描述",-1)),t("p",null,c(s.goodsDetail.goods_description),1)]),t("div",Te,[r[18]||(r[18]=t("h2",null,"评价区",-1)),t("div",Ee,[g(N,{modelValue:s.newComment,"onUpdate:modelValue":r[7]||(r[7]=i=>s.newComment=i),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),g(p,{type:"primary",onClick:s.submitComment,disabled:!s.newComment.trim()},{default:k(()=>r[13]||(r[13]=[E(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),t("div",je,[(_(!0),f(L,null,J(s.comments,i=>(_(),f("div",{key:i.id,class:"comment-item"},[t("div",qe,[t("img",{src:i.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,De),t("div",Pe,[t("div",Ne,c(i.username),1),t("div",Ue,c(i.content),1),t("div",Ae,[t("span",Ie,c(s.formatTime(i.create_time)),1),t("div",Le,[t("button",{class:"action-btn reply-btn",onClick:l=>s.toggleReply(i)},c(i.showReply?"取消回复":"回复"),9,Je),t("button",{class:j(["action-btn like-btn",{active:i.liked}]),onClick:l=>s.likeComment(i)},[r[14]||(r[14]=t("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),t("span",Be,c(i.likes),1)],10,xe),t("button",{class:j(["action-btn dislike-btn",{active:i.disliked}]),onClick:l=>s.dislikeComment(i)},[r[15]||(r[15]=t("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),t("span",Ve,c(i.dislikes),1)],10,Me)])])])]),i.replies&&i.replies.length>0?(_(),f("div",Fe,[(_(!0),f(L,null,J(i.replies,l=>(_(),f("div",{key:l.id,class:"reply-item"},[t("img",{src:l.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,ze),t("div",Ye,[t("div",Ge,c(l.username),1),t("div",He,c(l.content),1),t("div",Ke,[t("span",Qe,c(s.formatTime(l.create_time)),1),t("div",We,[t("button",{class:j(["action-btn like-btn",{active:l.liked}]),onClick:m=>s.likeReply(i,l)},[r[16]||(r[16]=t("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),t("span",Ze,c(l.likes),1)],10,Xe),t("button",{class:j(["action-btn dislike-btn",{active:l.disliked}]),onClick:m=>s.dislikeReply(i,l)},[r[17]||(r[17]=t("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),t("span",et,c(l.dislikes),1)],10,$e)])])])]))),128))])):T("",!0)]))),128))])])])])}const st=te(de,[["render",tt],["__scopeId","data-v-496f3535"]]);export{st as default};
