import{_ as oe,r as m,d as h,c as se,o as re,a as ie,b as y,e as t,f as v,w as k,g as M,h as ne,v as ae,t as c,i as A,j as I,F as L,k as J,u as de,E as u,l as g,m as _,n as T,p as E,q as le}from"./index-BcxhQ_ms.js";const ce={setup(){const a=de(),r=le(),b=m({}),s=m({}),C=m(""),S=m(!1),j=m(a.query.userAvatar||h);function q(e){e.stopPropagation(),S.value=!S.value}function w(e){e.target.closest(".user-profile")||(S.value=!1)}function D(){r.push({name:"UserProfile",query:{user_id:a.query.current_user_id,current_user_id:a.query.current_user_id,userAvatar:a.query.userAvatar,viewing_own_profile:"true"}})}function p(){console.log("查看通知")}function P(){console.log("查看消息")}function i(){console.log("联系我们")}const l=se(()=>["已下单","已送达"].includes(s.value.order_state));function f(e){try{const o=atob(e),n=[];for(let d=0;d<o.length;d+=512){const U=o.slice(d,d+512),B=new Array(U.length);for(let R=0;R<U.length;R++)B[R]=U.charCodeAt(R);const te=new Uint8Array(B);n.push(te)}return new Blob(n,{type:"image/jpeg"})}catch(o){return console.error("Error converting base64 to Blob:",o),null}}async function V(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id})});if(!e.ok)throw new Error("获取订单详情失败");const o=await e.json();o.success&&(s.value=o.order_detail,b.value={...o.goods_detail,goods_pictures:o.goods_detail.goods_pictures.map(n=>{if(n&&typeof n=="string")try{return URL.createObjectURL(f(n))}catch(d){return console.error("Error converting picture:",d),h}return h})},C.value=o.goods_detail.seller_picture?URL.createObjectURL(f(o.goods_detail.seller_picture)):h)}catch(e){console.error("Error fetching order detail:",e),u.error("获取订单详情失败")}}async function F(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id})});if(!e.ok)throw new Error("确认送达失败");(await e.json()).success&&(u.success("确认送达成功"),s.value.order_state="已送达")}catch(e){console.error("Error confirming delivery:",e),u.error("确认送达失败")}}async function z(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id})});if(!e.ok)throw new Error("申请退款失败");(await e.json()).success&&(u.success("退款申请已提交"),s.value.order_state="已退款")}catch(e){console.error("Error requesting refund:",e),u.error("申请退款失败")}}function Y(e){return e||"未知状态"}function G(){r.push({name:"UserProfile",query:{user_id:b.value.goods_detail.seller_id,current_user_id:a.query.current_user_id,userAvatar:C.value,isOwner:!1,viewing_own_profile:"false"}})}const x=m([]),O=m("");async function N(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_comments"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id})});if(!e.ok)throw new Error("获取评论失败");const o=await e.json();o.success&&(x.value=o.comments.map(n=>({...n,showReply:!1,replyContent:"",user_avatar:n.user_avatar?URL.createObjectURL(f(n.user_avatar)):h,replies:n.replies.map(d=>({...d,user_avatar:d.user_avatar?URL.createObjectURL(f(d.user_avatar)):h}))})))}catch(e){console.error("Error fetching comments:",e),u.error("获取评论失败")}}async function H(){if(O.value.trim())try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"add_comment"},body:JSON.stringify({goods_id:a.params.orderId,user_id:a.query.current_user_id,content:O.value})});if(!e.ok)throw new Error("发表评论失败");(await e.json()).success&&(u.success("评论发表成功"),O.value="",await N())}catch(e){console.error("Error submitting comment:",e),u.error("评论发表失败")}}function K(e){e.showReply=!e.showReply}async function Q(e){if(e.replyContent.trim())try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"add_reply"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,user_id:a.query.current_user_id,content:e.replyContent})});if(!o.ok)throw new Error("回复评论失败");(await o.json()).success&&(u.success("回复成功"),e.replyContent="",e.showReply=!1,await N())}catch(o){console.error("Error submitting reply:",o),u.error("回复失败")}}async function W(e){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_comment"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,user_id:a.query.current_user_id})});if(!o.ok)throw new Error("点赞失败");const n=await o.json();n.success&&(e.liked=!e.liked,e.likes=n.likes,e.disliked&&(e.disliked=!1,e.dislikes=n.dislikes))}catch(o){console.error("Error liking comment:",o),u.error("点赞失败")}}async function X(e){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_comment"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,user_id:a.query.current_user_id})});if(!o.ok)throw new Error("踩失败");const n=await o.json();n.success&&(e.disliked=!e.disliked,e.dislikes=n.dislikes,e.liked&&(e.liked=!1,e.likes=n.likes))}catch(o){console.error("Error disliking comment:",o),u.error("操作失败")}}function Z(e){const o=new Date(e),d=new Date-o;return d<6e4?"刚刚":d<36e5?`${Math.floor(d/6e4)}分钟前`:d<864e5?`${Math.floor(d/36e5)}小时前`:`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`}async function $(e,o){try{const n=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_reply"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,reply_id:o.id,user_id:a.query.current_user_id})});if(!n.ok)throw new Error("点赞失败");const d=await n.json();d.success&&(o.liked=!o.liked,o.likes=d.likes,o.disliked&&(o.disliked=!1,o.dislikes=d.dislikes))}catch(n){console.error("Error liking reply:",n),u.error("点赞失败")}}async function ee(e,o){try{const n=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_reply"},body:JSON.stringify({goods_id:a.params.orderId,comment_id:e.id,reply_id:o.id,user_id:a.query.current_user_id})});if(!n.ok)throw new Error("踩失败");const d=await n.json();d.success&&(o.disliked=!o.disliked,o.dislikes=d.dislikes,o.liked&&(o.liked=!1,o.likes=d.likes))}catch(n){console.error("Error disliking reply:",n),u.error("操作失败")}}return re(()=>{document.addEventListener("click",w),V(),N()}),ie(()=>{document.removeEventListener("click",w)}),{goodsDetail:b,orderDetail:s,sellerPicture:C,canRequestRefund:l,confirmDelivery:F,requestRefund:z,getOrderStatusText:Y,contactSeller:G,comments:x,newComment:O,submitComment:H,toggleReply:K,submitReply:Q,likeComment:W,dislikeComment:X,formatTime:Z,likeReply:$,dislikeReply:ee,base64ToBlob:f,toggleDropdown:q,closeDropdown:w,viewProfile:D,viewNotifications:p,viewMessages:P,contactUs:i,userAvatar:j}}},ue={class:"order-details-view"},_e={class:"header"},fe={class:"nav-container"},me={class:"user-section"},ye={class:"user-profile"},ke=["src"],pe={class:"good-details"},he={class:"good-info"},ve={class:"good-images"},ge=["src","alt"],we={class:"good-details-info"},be={class:"price"},Ce={class:"deal-time"},Se={class:"seller-info"},Oe=["src"],Re={class:"order-actions"},Te={class:"order-status"},Ee={class:"good-description"},je={class:"comments-section"},qe={class:"comment-input"},De={class:"comments-list"},Pe={class:"comment-main"},Ne=["src"],Ue={class:"comment-content"},Ae={class:"comment-user"},Ie={class:"comment-text"},Le={class:"comment-footer"},Je={class:"comment-time"},xe={class:"comment-actions"},Be=["onClick"],Me=["onClick"],Ve={class:"count"},Fe=["onClick"],ze={class:"count"},Ye={key:0,class:"reply-list"},Ge=["src"],He={class:"comment-content"},Ke={class:"comment-user"},Qe={class:"comment-text"},We={class:"comment-footer"},Xe={class:"comment-time"},Ze={class:"comment-actions"},$e=["onClick"],et={class:"count"},tt=["onClick"],ot={class:"count"};function st(a,r,b,s,C,S){const j=g("Bell"),q=g("el-icon"),w=g("el-carousel-item"),D=g("el-carousel"),p=g("el-button"),P=g("el-input");return _(),y("div",ue,[t("header",_e,[t("div",fe,[r[8]||(r[8]=t("div",{class:"welcome-text"},"欢迎使用二手交易平台",-1)),t("div",me,[t("button",{class:"announcement-btn",onClick:r[0]||(r[0]=(...i)=>a.fetchAnnouncements&&a.fetchAnnouncements(...i))},[v(q,null,{default:k(()=>[v(j)]),_:1})]),t("div",ye,[t("img",{src:s.userAvatar,alt:"用户头像",class:"avatar",onClick:r[1]||(r[1]=M((...i)=>s.toggleDropdown&&s.toggleDropdown(...i),["stop"]))},null,8,ke),ne(t("div",{class:"dropdown-menu",onClick:r[6]||(r[6]=M(()=>{},["stop"]))},[t("button",{onClick:r[2]||(r[2]=(...i)=>s.viewProfile&&s.viewProfile(...i))},"个人信息"),t("button",{onClick:r[3]||(r[3]=(...i)=>s.viewNotifications&&s.viewNotifications(...i))},"我的通知"),t("button",{onClick:r[4]||(r[4]=(...i)=>s.viewMessages&&s.viewMessages(...i))},"我的消息"),t("button",{onClick:r[5]||(r[5]=(...i)=>s.contactUs&&s.contactUs(...i))},"联系我们")],512),[[ae,a.dropdownVisible]])])])])]),t("div",pe,[t("div",he,[t("div",ve,[v(D,{height:"400px"},{default:k(()=>[(_(!0),y(L,null,J(s.goodsDetail.goods_pictures,(i,l)=>(_(),A(w,{key:l},{default:k(()=>[t("img",{src:i,alt:`商品图片${l+1}`,class:"carousel-image"},null,8,ge)]),_:2},1024))),128))]),_:1})]),t("div",we,[t("h1",null,c(s.goodsDetail.goods_name),1),t("div",be,"¥"+c(s.goodsDetail.goods_price),1),t("div",Ce,"下单时间："+c(s.formatTime(s.orderDetail.deal_time)),1),t("div",Se,[t("img",{src:s.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,Oe),v(p,{type:"text",onClick:s.contactSeller},{default:k(()=>r[9]||(r[9]=[T("联系卖家")])),_:1},8,["onClick"])]),t("div",Re,[t("div",Te," 订单状态："+c(s.getOrderStatusText(s.orderDetail.order_state)),1),s.orderDetail.order_state==="已下单"?(_(),A(p,{key:0,type:"primary",onClick:s.confirmDelivery},{default:k(()=>r[10]||(r[10]=[T(" 确认送达 ")])),_:1},8,["onClick"])):I("",!0),s.canRequestRefund?(_(),A(p,{key:1,type:"danger",onClick:s.requestRefund},{default:k(()=>r[11]||(r[11]=[T(" 申请退款 ")])),_:1},8,["onClick"])):I("",!0)])])]),t("div",Ee,[r[12]||(r[12]=t("h2",null,"商品描述",-1)),t("p",null,c(s.goodsDetail.goods_description),1)]),t("div",je,[r[18]||(r[18]=t("h2",null,"评价区",-1)),t("div",qe,[v(P,{modelValue:s.newComment,"onUpdate:modelValue":r[7]||(r[7]=i=>s.newComment=i),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),v(p,{type:"primary",onClick:s.submitComment,disabled:!s.newComment.trim()},{default:k(()=>r[13]||(r[13]=[T(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),t("div",De,[(_(!0),y(L,null,J(s.comments,i=>(_(),y("div",{key:i.id,class:"comment-item"},[t("div",Pe,[t("img",{src:i.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,Ne),t("div",Ue,[t("div",Ae,c(i.username),1),t("div",Ie,c(i.content),1),t("div",Le,[t("span",Je,c(s.formatTime(i.create_time)),1),t("div",xe,[t("button",{class:"action-btn reply-btn",onClick:l=>s.toggleReply(i)},c(i.showReply?"取消回复":"回复"),9,Be),t("button",{class:E(["action-btn like-btn",{active:i.liked}]),onClick:l=>s.likeComment(i)},[r[14]||(r[14]=t("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),t("span",Ve,c(i.likes),1)],10,Me),t("button",{class:E(["action-btn dislike-btn",{active:i.disliked}]),onClick:l=>s.dislikeComment(i)},[r[15]||(r[15]=t("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),t("span",ze,c(i.dislikes),1)],10,Fe)])])])]),i.replies&&i.replies.length>0?(_(),y("div",Ye,[(_(!0),y(L,null,J(i.replies,l=>(_(),y("div",{key:l.id,class:"reply-item"},[t("img",{src:l.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,Ge),t("div",He,[t("div",Ke,c(l.username),1),t("div",Qe,c(l.content),1),t("div",We,[t("span",Xe,c(s.formatTime(l.create_time)),1),t("div",Ze,[t("button",{class:E(["action-btn like-btn",{active:l.liked}]),onClick:f=>s.likeReply(i,l)},[r[16]||(r[16]=t("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),t("span",et,c(l.likes),1)],10,$e),t("button",{class:E(["action-btn dislike-btn",{active:l.disliked}]),onClick:f=>s.dislikeReply(i,l)},[r[17]||(r[17]=t("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),t("span",ot,c(l.dislikes),1)],10,tt)])])])]))),128))])):I("",!0)]))),128))])])])])}const it=oe(ce,[["render",st],["__scopeId","data-v-5b7f7af0"]]);export{it as default};
