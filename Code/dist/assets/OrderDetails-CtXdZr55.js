import{_ as H,r as p,c as K,o as Q,a as m,b as s,d as C,w as y,t as c,e as N,f as P,F as x,g as I,h as k,E as u,i as O,j as _,k as S,n as R,u as W,l as X}from"./index-BYQC10l1.js";const Z={setup(){const d=W(),i=X(),T=p({}),o=p({}),g=p(""),U=K(()=>["已下单","已送达"].includes(o.value.order_state));function f(e){try{const t=atob(e),r=[];for(let a=0;a<t.length;a+=512){const D=t.slice(a,a+512),J=new Array(D.length);for(let b=0;b<D.length;b++)J[b]=D.charCodeAt(b);const G=new Uint8Array(J);r.push(G)}return new Blob(r,{type:"image/jpeg"})}catch(t){return console.error("Error converting base64 to Blob:",t),null}}async function j(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("获取订单详情失败");const t=await e.json();t.success&&(o.value=t.order_detail,T.value={...t.goods_detail,goods_pictures:t.goods_detail.goods_pictures.map(r=>{if(r&&typeof r=="string")try{return URL.createObjectURL(f(r))}catch(a){return console.error("Error converting picture:",a),k}return k})},g.value=t.goods_detail.seller_picture?URL.createObjectURL(f(t.goods_detail.seller_picture)):k)}catch(e){console.error("Error fetching order detail:",e),u.error("获取订单详情失败")}}async function h(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("确认送达失败");(await e.json()).success&&(u.success("确认送达成功"),o.value.order_state="已送达")}catch(e){console.error("Error confirming delivery:",e),u.error("确认送达失败")}}async function E(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("申请退款失败");(await e.json()).success&&(u.success("退款申请已提交"),o.value.order_state="已退款")}catch(e){console.error("Error requesting refund:",e),u.error("申请退款失败")}}function n(e){return e||"未知状态"}function l(){i.push({name:"UserProfile",query:{user_id:o.value.seller_id,current_user_id:d.query.current_user_id,userAvatar:g.value,isOwner:!1,viewing_own_profile:"false"}})}const v=p([]),w=p("");async function q(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_comments"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("获取评论失败");const t=await e.json();t.success&&(v.value=t.comments.map(r=>({...r,showReply:!1,replyContent:"",user_avatar:r.user_avatar?URL.createObjectURL(f(r.user_avatar)):k,replies:r.replies.map(a=>({...a,user_avatar:a.user_avatar?URL.createObjectURL(f(a.user_avatar)):k}))})))}catch(e){console.error("Error fetching comments:",e),u.error("获取评论失败")}}async function L(){if(w.value.trim())try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"add_comment"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id,content:w.value})});if(!e.ok)throw new Error("发表评论失败");(await e.json()).success&&(u.success("评论发表成功"),w.value="",await q())}catch(e){console.error("Error submitting comment:",e),u.error("评论发表失败")}}function A(e){e.showReply=!e.showReply}async function B(e){if(e.replyContent.trim())try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"add_reply"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,user_id:d.query.current_user_id,content:e.replyContent})});if(!t.ok)throw new Error("回复评论失败");(await t.json()).success&&(u.success("回复成功"),e.replyContent="",e.showReply=!1,await q())}catch(t){console.error("Error submitting reply:",t),u.error("回复失败")}}async function V(e){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("点赞失败");const r=await t.json();r.success&&(e.liked=!e.liked,e.likes=r.likes,e.disliked&&(e.disliked=!1,e.dislikes=r.dislikes))}catch(t){console.error("Error liking comment:",t),u.error("点赞失败")}}async function M(e){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("踩失败");const r=await t.json();r.success&&(e.disliked=!e.disliked,e.dislikes=r.dislikes,e.liked&&(e.liked=!1,e.likes=r.likes))}catch(t){console.error("Error disliking comment:",t),u.error("操作失败")}}function F(e){const t=new Date(e),a=new Date-t;return a<6e4?"刚刚":a<36e5?`${Math.floor(a/6e4)}分钟前`:a<864e5?`${Math.floor(a/36e5)}小时前`:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async function z(e,t){try{const r=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_reply"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,reply_id:t.id,user_id:d.query.current_user_id})});if(!r.ok)throw new Error("点赞失败");const a=await r.json();a.success&&(t.liked=!t.liked,t.likes=a.likes,t.disliked&&(t.disliked=!1,t.dislikes=a.dislikes))}catch(r){console.error("Error liking reply:",r),u.error("点赞失败")}}async function Y(e,t){try{const r=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_reply"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,reply_id:t.id,user_id:d.query.current_user_id})});if(!r.ok)throw new Error("踩失败");const a=await r.json();a.success&&(t.disliked=!t.disliked,t.dislikes=a.dislikes,t.liked&&(t.liked=!1,t.likes=a.likes))}catch(r){console.error("Error disliking reply:",r),u.error("操作失败")}}return Q(async()=>{await j(),await q()}),{goodsDetail:T,orderDetail:o,sellerPicture:g,canRequestRefund:U,confirmDelivery:h,requestRefund:E,getOrderStatusText:n,contactSeller:l,comments:v,newComment:w,submitComment:L,toggleReply:A,submitReply:B,likeComment:V,dislikeComment:M,formatTime:F,likeReply:z,dislikeReply:Y,base64ToBlob:f}}},$={class:"good-details"},ee={class:"good-info"},te={class:"good-images"},se=["src","alt"],oe={class:"good-details-info"},re={class:"price"},ie={class:"deal-time"},ne={class:"seller-info"},ae=["src"],de={class:"order-actions"},le={class:"order-status"},ce={class:"good-description"},ue={class:"comments-section"},_e={class:"comment-input"},fe={class:"comments-list"},me={class:"comment-main"},he=["src"],ye={class:"comment-content"},pe={class:"comment-user"},ke={class:"comment-text"},ge={class:"comment-footer"},ve={class:"comment-time"},we={class:"comment-actions"},be=["onClick"],Ce=["onClick"],Oe={class:"count"},Se=["onClick"],Re={class:"count"},Te={key:0,class:"reply-list"},je=["src"],Ee={class:"comment-content"},qe={class:"comment-user"},De={class:"comment-text"},Ne={class:"comment-footer"},Pe={class:"comment-time"},xe={class:"comment-actions"},Ie=["onClick"],Ue={class:"count"},Je=["onClick"],Le={class:"count"};function Ae(d,i,T,o,g,U){const f=O("el-carousel-item"),j=O("el-carousel"),h=O("el-button"),E=O("el-input");return _(),m("div",$,[s("div",ee,[s("div",te,[C(j,{height:"400px"},{default:y(()=>[(_(!0),m(x,null,I(o.goodsDetail.goods_pictures,(n,l)=>(_(),N(f,{key:l},{default:y(()=>[s("img",{src:n,alt:`商品图片${l+1}`,class:"carousel-image"},null,8,se)]),_:2},1024))),128))]),_:1})]),s("div",oe,[s("h1",null,c(o.goodsDetail.goods_name),1),s("div",re,"¥"+c(o.goodsDetail.goods_price),1),s("div",ie,"下单时间："+c(o.formatTime(o.orderDetail.deal_time)),1),s("div",ne,[s("img",{src:o.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,ae),C(h,{type:"text",onClick:o.contactSeller},{default:y(()=>i[1]||(i[1]=[S("联系卖家")])),_:1},8,["onClick"])]),s("div",de,[s("div",le," 订单状态："+c(o.getOrderStatusText(o.orderDetail.order_state)),1),o.orderDetail.order_state==="已下单"?(_(),N(h,{key:0,type:"primary",onClick:o.confirmDelivery},{default:y(()=>i[2]||(i[2]=[S(" 确认送达 ")])),_:1},8,["onClick"])):P("",!0),o.canRequestRefund?(_(),N(h,{key:1,type:"danger",onClick:o.requestRefund},{default:y(()=>i[3]||(i[3]=[S(" 申请退款 ")])),_:1},8,["onClick"])):P("",!0)])])]),s("div",ce,[i[4]||(i[4]=s("h2",null,"商品描述",-1)),s("p",null,c(o.goodsDetail.goods_description),1)]),s("div",ue,[i[10]||(i[10]=s("h2",null,"评价区",-1)),s("div",_e,[C(E,{modelValue:o.newComment,"onUpdate:modelValue":i[0]||(i[0]=n=>o.newComment=n),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),C(h,{type:"primary",onClick:o.submitComment,disabled:!o.newComment.trim()},{default:y(()=>i[5]||(i[5]=[S(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),s("div",fe,[(_(!0),m(x,null,I(o.comments,n=>(_(),m("div",{key:n.id,class:"comment-item"},[s("div",me,[s("img",{src:n.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,he),s("div",ye,[s("div",pe,c(n.username),1),s("div",ke,c(n.content),1),s("div",ge,[s("span",ve,c(o.formatTime(n.create_time)),1),s("div",we,[s("button",{class:"action-btn reply-btn",onClick:l=>o.toggleReply(n)},c(n.showReply?"取消回复":"回复"),9,be),s("button",{class:R(["action-btn like-btn",{active:n.liked}]),onClick:l=>o.likeComment(n)},[i[6]||(i[6]=s("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),s("span",Oe,c(n.likes),1)],10,Ce),s("button",{class:R(["action-btn dislike-btn",{active:n.disliked}]),onClick:l=>o.dislikeComment(n)},[i[7]||(i[7]=s("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),s("span",Re,c(n.dislikes),1)],10,Se)])])])]),n.replies&&n.replies.length>0?(_(),m("div",Te,[(_(!0),m(x,null,I(n.replies,l=>(_(),m("div",{key:l.id,class:"reply-item"},[s("img",{src:l.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,je),s("div",Ee,[s("div",qe,c(l.username),1),s("div",De,c(l.content),1),s("div",Ne,[s("span",Pe,c(o.formatTime(l.create_time)),1),s("div",xe,[s("button",{class:R(["action-btn like-btn",{active:l.liked}]),onClick:v=>o.likeReply(n,l)},[i[8]||(i[8]=s("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),s("span",Ue,c(l.likes),1)],10,Ie),s("button",{class:R(["action-btn dislike-btn",{active:l.disliked}]),onClick:v=>o.dislikeReply(n,l)},[i[9]||(i[9]=s("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),s("span",Le,c(l.dislikes),1)],10,Je)])])])]))),128))])):P("",!0)]))),128))])])])}const Ve=H(Z,[["render",Ae],["__scopeId","data-v-82812857"]]);export{Ve as default};
