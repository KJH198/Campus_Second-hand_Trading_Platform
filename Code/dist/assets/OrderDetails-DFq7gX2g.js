import{_ as se,b as ne,p as ie,r as f,d as b,c as ae,o as le,a as ce,e as h,f as e,g as p,w as E,h as de,i as K,t as _,F as Q,j as W,u as ue,E as c,k as w,l as v,m as _e,n as me,q as L,s as fe,v as ve,x as he}from"./index-D2kZ_bjK.js";const pe={components:{Bell:ne,Phone:ie},setup(){const d=ue(),r=he(),j=f({}),o=f({}),R=f(""),N=f(!1),M=f(d.query.userAvatar||b);function A(t){t.stopPropagation(),N.value=!N.value}function C(t){t.target.closest(".user-profile")||(N.value=!1)}function B(){r.push({name:"UserProfile",query:{user_id:d.query.current_user_id,current_user_id:d.query.current_user_id,userAvatar:d.query.userAvatar,viewing_own_profile:"true"}})}function J(){console.log("查看通知")}function P(){console.log("查看消息")}function z(){console.log("联系我们")}const Y=ae(()=>["已下单","已送达"].includes(o.value.order_state));function g(t){try{const n=atob(t),u=[];for(let l=0;l<n.length;l+=512){const m=n.slice(l,l+512),i=new Array(m.length);for(let I=0;I<m.length;I++)i[I]=m.charCodeAt(I);const T=new Uint8Array(i);u.push(T)}return new Blob(u,{type:"image/jpeg"})}catch(n){return console.error("Error converting base64 to Blob:",n),null}}async function D(){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("获取订单详情失败");const n=await t.json();console.log(n),n.success&&(o.value=n.order_detail,console.log(o.value),j.value={...n.goods_detail,goods_pictures:n.goods_detail.goods_pictures.map(u=>{if(u&&typeof u=="string")try{return URL.createObjectURL(g(u))}catch(l){return console.error("Error converting picture:",l),b}return b})},R.value=n.goods_detail.seller_picture?URL.createObjectURL(g(n.goods_detail.seller_picture)):b)}catch(t){console.error("Error fetching order detail:",t),c.error("获取订单详情失败")}}async function U(){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("确认送达失败");(await t.json()).success&&(c.success("确认送达成功"),o.value.order_state="已送达")}catch(t){console.error("Error confirming delivery:",t),c.error("确认送达失败")}}async function q(){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("申请退款失败");(await t.json()).success&&(c.success("退款申请已提交"),o.value.order_state="已退款")}catch(t){console.error("Error requesting refund:",t),c.error("申请退款失败")}}function s(t){return t||"未知状态"}function a(){r.push({name:"UserProfile",query:{user_id:j.value.seller_id,current_user_id:d.query.current_user_id,userAvatar:R.value,isOwner:!1,viewing_own_profile:"false"}})}const S=f([]),V=f(""),y=f(new Map),O=f(null),k=f(""),F=f(0);async function G(){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"comments"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("Failed to fetch comments");const u=(await t.json()).map(l=>{const m={...l,level:1,deliver_picture:l.picture?URL.createObjectURL(g(l.picture)):b};return l.reply&&Array.isArray(l.reply)&&(m.reply=l.reply.map(i=>({...i,level:2,deliver_picture:i.picture?URL.createObjectURL(g(i.picture)):b}))),m});S.value=u,console.log("评论列表：",S.value)}catch(t){console.error("Error fetching comments:",t),c.error("获取评论失败")}}async function X(){if(!V.value.trim()){c.warning("评论内容不能为空");return}if(!F.value){c.warning("请给出评分");return}try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment:V.value,deliver_id:d.query.current_user_id,order_grade:F.value})});if(!t.ok)throw new Error("Network response was not ok");(await t.json()).success?(c.success("评论发表成功！"),await G(),V.value="",F.value=0):c.error("评论发表失败，请重试")}catch(t){console.error("Error submitting comment:",t),c.error("评论发表失败，请稍后重试")}}function Z(t){O.value===t.order_comment_id?(O.value=null,k.value=""):(O.value=t.order_comment_id,k.value="")}async function $(t){if(!k.value.trim()){c.warning("回复内容不能为空");return}try{const n=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_reply"},body:JSON.stringify({order_comment_id:t,comment:k.value,deliver_id:d.query.current_user_id})});if(!n.ok)throw new Error("Network response was not ok");(await n.json()).success?(c.success("回复成功"),k.value="",O.value=null,await G()):c.error("回复失败，请重试")}catch(n){console.error("Error submitting reply:",n),c.error("回复失败，请稍后重试")}}function ee(t){if(!t)return"暂无时间信息";try{const n=new Date(t),l=new Date-n;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分钟前`:l<864e5?`${Math.floor(l/36e5)}小时前`:`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`}catch(n){return console.error("Error formatting time:",n),"时间格式错误"}}function x(t){return t.level===2}function H(t){return t.level===2?`reply_${t.secondary_order_comment_id}`:`comment_${t.order_comment_id}`}function te(t){const n=H(t);return y.value.get(n)||null}async function oe(t){const n=H(t),u=x(t)?2:1,l=x(t)?t.secondary_order_comment_id:t.order_comment_id,m=y.value.get(n);if(m==="like"){try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:u,id:l,cancel:!0})});if(!i.ok)throw new Error("Network response was not ok");(await i.json()).success&&(t.helpful-=1,y.value.delete(n),c.success("已取消点赞"))}catch(i){console.error("Error handling like:",i),c.error("操作失败，请稍后重试")}return}if(m==="dislike"){c.warning("您已经点过踩了，如需点赞请先取消点踩");return}try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:u,id:l,cancel:!1})});if(!i.ok)throw new Error("Network response was not ok");(await i.json()).success&&(t.helpful+=1,y.value.set(n,"like"),c.success("点赞成功"))}catch(i){console.error("Error handling like:",i),c.error("操作失败，请稍后重试")}}async function re(t){const n=H(t),u=x(t)?2:1,l=x(t)?t.secondary_order_comment_id:t.order_comment_id,m=y.value.get(n);if(m==="dislike"){try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:u,id:l,cancel:!0})});if(!i.ok)throw new Error("Network response was not ok");(await i.json()).success&&(t.unhelpful-=1,y.value.delete(n),c.success("已取消点踩"))}catch(i){console.error("Error handling dislike:",i),c.error("操作失败，请稍后重试")}return}if(m==="like"){c.warning("您已经点过赞了，如需点踩请先取消点赞");return}try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:u,id:l,cancel:!1})});if(!i.ok)throw new Error("Network response was not ok");(await i.json()).success&&(t.unhelpful+=1,y.value.set(n,"dislike"),c.success("点踩成功"))}catch(i){console.error("Error handling dislike:",i),c.error("操作失败，请稍后重试")}}return le(()=>{document.addEventListener("click",C),D(),G()}),ce(()=>{document.removeEventListener("click",C)}),{goodsDetail:j,orderDetail:o,sellerPicture:R,canRequestRefund:Y,confirmDelivery:U,requestRefund:q,getOrderStatusText:s,contactSeller:a,comments:S,newComment:V,submitComment:X,toggleReply:Z,formatTime:ee,base64ToBlob:g,toggleDropdown:A,closeDropdown:C,viewProfile:B,viewNotifications:J,viewMessages:P,contactUs:z,userAvatar:M,commentActions:y,activeReplyId:O,replyContent:k,getCommentAction:te,handleLike:oe,handleDislike:re,submitReply:$,commentRating:F}}},ge={class:"order-details-view"},ye={class:"header"},we={class:"nav-container"},ke={class:"user-section"},be={key:0,class:"dropdown-menu"},Ce={class:"good-details"},Se={class:"good-info"},Oe={class:"good-images"},Te=["src","alt"],Ee={class:"good-details-info"},je={class:"price"},Re={class:"deal-time"},Ne={class:"seller-info"},Ae=["src"],Pe={class:"order-actions"},De={class:"order-status"},Ue={class:"good-description"},qe={class:"comments-section"},Ve={class:"comment-input"},Fe={class:"rating-section"},xe={class:"comments-list"},Ie={class:"comment-main"},Le=["src"],Me={class:"comment-content"},Be={class:"comment-header"},Je={class:"comment-user"},ze={class:"comment-rating"},Ye={class:"comment-text"},Ge={class:"comment-footer"},He={class:"comment-time"},Ke={class:"comment-actions"},Qe=["onClick"],We=["onClick"],Xe={class:"count"},Ze=["onClick"],$e={class:"count"},et={key:0,class:"reply-input-container"},tt={class:"reply-actions"},ot=["onClick"],rt=["onClick"],st={key:1,class:"reply-list"},nt=["src"],it={class:"comment-content"},at={class:"comment-user"},lt={class:"comment-text"},ct={class:"comment-footer"},dt={class:"comment-time"},ut={class:"comment-actions"},_t=["onClick"],mt={class:"count"},ft=["onClick"],vt={class:"count"};function ht(d,r,j,o,R,N){var g,D,U,q;const M=w("Bell"),A=w("el-icon"),C=w("el-carousel-item"),B=w("el-carousel"),J=w("Phone"),P=w("el-rate"),z=w("el-input"),Y=w("el-button");return v(),h("div",ge,[e("header",ye,[e("div",we,[r[10]||(r[10]=e("div",{class:"welcome-text"},"欢迎使用二手交易平台",-1)),e("div",ke,[e("button",{class:"announcement-btn",onClick:r[0]||(r[0]=(...s)=>d.fetchAnnouncements&&d.fetchAnnouncements(...s))},[p(A,null,{default:E(()=>[p(M)]),_:1})]),e("div",{class:"user-profile",onClick:r[5]||(r[5]=de(()=>{},["stop"]))},[d.dropdownVisible?(v(),h("div",be,[e("button",{onClick:r[1]||(r[1]=(...s)=>o.viewProfile&&o.viewProfile(...s))},"个人信息"),e("button",{onClick:r[2]||(r[2]=(...s)=>o.viewNotifications&&o.viewNotifications(...s))},"我的通知"),e("button",{onClick:r[3]||(r[3]=(...s)=>o.viewMessages&&o.viewMessages(...s))},"我的消息"),e("button",{onClick:r[4]||(r[4]=(...s)=>o.contactUs&&o.contactUs(...s))},"联系我们")])):K("",!0)])])])]),e("div",Ce,[e("div",Se,[e("div",Oe,[p(B,{height:"400px"},{default:E(()=>[(v(!0),h(Q,null,W(o.goodsDetail.goods_pictures,(s,a)=>(v(),_e(C,{key:a},{default:E(()=>[e("img",{src:s,alt:`商品图片${a+1}`,class:"carousel-image"},null,8,Te)]),_:2},1024))),128))]),_:1})]),e("div",Ee,[e("h1",null,_((g=o.goodsDetail)==null?void 0:g.goods_name),1),e("div",je,"¥"+_((D=o.goodsDetail)==null?void 0:D.goods_price),1),e("div",Re,"下单时间："+_(o.formatTime((U=o.orderDetail)==null?void 0:U.deal_time)),1),e("div",Ne,[e("img",{src:o.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,Ae),e("button",{class:"contact-btn",onClick:r[6]||(r[6]=(...s)=>o.contactSeller&&o.contactSeller(...s))},[p(A,null,{default:E(()=>[p(J)]),_:1}),r[11]||(r[11]=e("span",null,"联系卖家",-1))])]),e("div",Pe,[e("div",De," 订单状态："+_(o.getOrderStatusText(o.orderDetail.order_state)),1)])])]),e("div",Ue,[r[12]||(r[12]=e("h2",null,"商品描述",-1)),e("p",null,_((q=o.goodsDetail)==null?void 0:q.goods_description),1)]),e("div",qe,[r[19]||(r[19]=e("h2",null,"评价区",-1)),e("div",Ve,[e("div",Fe,[r[13]||(r[13]=e("span",{class:"rating-label"},"评分：",-1)),p(P,{modelValue:o.commentRating,"onUpdate:modelValue":r[7]||(r[7]=s=>o.commentRating=s),colors:["#FF9900","#FF9900","#FF9900"],texts:["1星","2星","3星","4星","5星"],"show-text":""},null,8,["modelValue"])]),p(z,{modelValue:o.newComment,"onUpdate:modelValue":r[8]||(r[8]=s=>o.newComment=s),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),p(Y,{type:"primary",onClick:o.submitComment,disabled:!o.newComment.trim()||!o.commentRating},{default:E(()=>r[14]||(r[14]=[me(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),e("div",xe,[(v(!0),h(Q,null,W(o.comments,s=>(v(),h("div",{key:s.order_comment_id,class:"comment-item"},[e("div",Ie,[e("img",{src:s.deliver_picture,alt:"用户头像",class:"comment-avatar"},null,8,Le),e("div",Me,[e("div",Be,[e("div",Je,_(s.deliver_name),1),e("div",ze,[p(P,{modelValue:s.order_grade,"onUpdate:modelValue":a=>s.order_grade=a,disabled:"","show-score":"","text-color":"#ff9900",colors:["#FF9900","#FF9900","#FF9900"]},null,8,["modelValue","onUpdate:modelValue"])])]),e("div",Ye,_(s.comment),1),e("div",Ge,[e("span",He,_(o.formatTime(s.comment_time)),1),e("div",Ke,[e("button",{class:"action-btn reply-btn",onClick:a=>o.toggleReply(s)},_(o.activeReplyId===s.order_comment_id?"取消回复":"回复"),9,Qe),e("button",{class:L(["action-btn like-btn",{active:o.getCommentAction(s)==="like"}]),onClick:a=>o.handleLike(s)},[r[15]||(r[15]=e("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),e("span",Xe,_(s.helpful),1)],10,We),e("button",{class:L(["action-btn dislike-btn",{active:o.getCommentAction(s)==="dislike"}]),onClick:a=>o.handleDislike(s)},[r[16]||(r[16]=e("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),e("span",$e,_(s.unhelpful),1)],10,Ze)])])])]),o.activeReplyId===s.order_comment_id?(v(),h("div",et,[fe(e("textarea",{"onUpdate:modelValue":r[9]||(r[9]=a=>o.replyContent=a),placeholder:"写下你的回复...",rows:"2",class:"reply-textarea"},null,512),[[ve,o.replyContent]]),e("div",tt,[e("button",{class:"cancel-btn",onClick:a=>o.toggleReply(s)},"取消",8,ot),e("button",{class:"submit-btn",onClick:a=>o.submitReply(s.order_comment_id)},"发送",8,rt)])])):K("",!0),s.reply&&s.reply.length>0?(v(),h("div",st,[(v(!0),h(Q,null,W(s.reply,a=>(v(),h("div",{key:a.secondary_order_comment_id,class:"reply-item"},[e("img",{src:a.deliver_picture,alt:"用户头像",class:"comment-avatar"},null,8,nt),e("div",it,[e("div",at,_(a.deliver_name),1),e("div",lt,_(a.comment),1),e("div",ct,[e("span",dt,_(o.formatTime(a.comment_time)),1),e("div",ut,[e("button",{class:L(["action-btn like-btn",{active:o.getCommentAction(a)==="like"}]),onClick:S=>o.handleLike(a)},[r[17]||(r[17]=e("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),e("span",mt,_(a.helpful),1)],10,_t),e("button",{class:L(["action-btn dislike-btn",{active:o.getCommentAction(a)==="dislike"}]),onClick:S=>o.handleDislike(a)},[r[18]||(r[18]=e("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),e("span",vt,_(a.unhelpful),1)],10,ft)])])])]))),128))])):K("",!0)]))),128))])])])])}const gt=se(pe,[["render",ht],["__scopeId","data-v-9ce169d5"]]);export{gt as default};
