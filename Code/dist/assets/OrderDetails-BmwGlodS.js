import{_ as ce,r as y,d as S,c as ue,o as _e,a as fe,b as p,e as o,f as h,w as g,g as me,h as j,t as _,i as W,F as X,j as Z,u as ye,E as l,k as w,l as m,m as L,n as J,p as pe,v as ke,q as ve}from"./index-DQUZ2fMH.js";const he={setup(){const d=ye(),s=ve(),R=y({}),r=y({}),N=y(""),D=y(!1),M=y(d.query.userAvatar||S);function B(e){e.stopPropagation(),D.value=!D.value}function O(e){e.target.closest(".user-profile")||(D.value=!1)}function z(){s.push({name:"UserProfile",query:{user_id:d.query.current_user_id,current_user_id:d.query.current_user_id,userAvatar:d.query.userAvatar,viewing_own_profile:"true"}})}function b(){console.log("查看通知")}function q(){console.log("查看消息")}function Y(){console.log("联系我们")}const A=ue(()=>["已下单","已送达"].includes(r.value.order_state));function k(e){try{const t=atob(e),i=[];for(let a=0;a<t.length;a+=512){const f=t.slice(a,a+512),c=new Array(f.length);for(let x=0;x<f.length;x++)c[x]=f.charCodeAt(x);const E=new Uint8Array(c);i.push(E)}return new Blob(i,{type:"image/jpeg"})}catch(t){return console.error("Error converting base64 to Blob:",t),null}}async function P(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("获取订单详情失败");const t=await e.json();console.log(t),t.success&&(r.value=t.order_detail,console.log(r.value),R.value={...t.goods_detail,goods_pictures:t.goods_detail.goods_pictures.map(i=>{if(i&&typeof i=="string")try{return URL.createObjectURL(k(i))}catch(a){return console.error("Error converting picture:",a),S}return S})},N.value=t.goods_detail.seller_picture?URL.createObjectURL(k(t.goods_detail.seller_picture)):S)}catch(e){console.error("Error fetching order detail:",e),l.error("获取订单详情失败")}}async function U(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("确认送达失败");(await e.json()).success&&(l.success("确认送达成功"),r.value.order_state="已送达")}catch(e){console.error("Error confirming delivery:",e),l.error("确认送达失败")}}async function n(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("申请退款失败");(await e.json()).success&&(l.success("退款申请已提交"),r.value.order_state="已退款")}catch(e){console.error("Error requesting refund:",e),l.error("申请退款失败")}}function u(e){return e||"未知状态"}function G(){s.push({name:"UserProfile",query:{user_id:R.value.seller_id,current_user_id:d.query.current_user_id,userAvatar:N.value,isOwner:!1,viewing_own_profile:"false"}})}const H=y([]),I=y(""),v=y(new Map),T=y(null),C=y(""),V=y(0);async function K(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"comments"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!e.ok)throw new Error("Failed to fetch comments");const i=(await e.json()).map(a=>{const f={...a,level:1,deliver_picture:a.picture?URL.createObjectURL(k(a.picture)):S};return a.reply&&Array.isArray(a.reply)&&(f.reply=a.reply.map(c=>({...c,level:2,deliver_picture:c.picture?URL.createObjectURL(k(c.picture)):S}))),f});H.value=i,console.log("评论列表：",H.value)}catch(e){console.error("Error fetching comments:",e),l.error("获取评论失败")}}async function $(){if(!I.value.trim()){l.warning("评论内容不能为空");return}if(!V.value){l.warning("请给出评分");return}try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment:I.value,deliver_id:d.query.current_user_id,order_grade:V.value})});if(!e.ok)throw new Error("Network response was not ok");(await e.json()).success?(l.success("评论发表成功！"),await K(),I.value="",V.value=0):l.error("评论发表失败，请重试")}catch(e){console.error("Error submitting comment:",e),l.error("评论发表失败，请稍后重试")}}function ee(e){T.value===e.order_comment_id?(T.value=null,C.value=""):(T.value=e.order_comment_id,C.value="")}async function oe(e){if(!C.value.trim()){l.warning("回复内容不能为空");return}try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_reply"},body:JSON.stringify({order_comment_id:e,comment:C.value,deliver_id:d.query.current_user_id})});if(!t.ok)throw new Error("Network response was not ok");(await t.json()).success?(l.success("回复成功"),C.value="",T.value=null,await K()):l.error("回复失败，请重试")}catch(t){console.error("Error submitting reply:",t),l.error("回复失败，请稍后重试")}}async function te(e){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("点赞失败");const i=await t.json();i.success&&(e.liked=!e.liked,e.likes=i.likes,e.disliked&&(e.disliked=!1,e.dislikes=i.dislikes))}catch(t){console.error("Error liking comment:",t),l.error("点赞失败")}}async function re(e){try{const t=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,user_id:d.query.current_user_id})});if(!t.ok)throw new Error("踩失败");const i=await t.json();i.success&&(e.disliked=!e.disliked,e.dislikes=i.dislikes,e.liked&&(e.liked=!1,e.likes=i.likes))}catch(t){console.error("Error disliking comment:",t),l.error("操作失败")}}function se(e){if(!e)return"暂无时间信息";try{const t=new Date(e),a=new Date-t;return a<6e4?"刚刚":a<36e5?`${Math.floor(a/6e4)}分钟前`:a<864e5?`${Math.floor(a/36e5)}小时前`:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(t){return console.error("Error formatting time:",t),"时间格式错误"}}async function ne(e,t){try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_reply"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,reply_id:t.id,user_id:d.query.current_user_id})});if(!i.ok)throw new Error("点赞失败");const a=await i.json();a.success&&(t.liked=!t.liked,t.likes=a.likes,t.disliked&&(t.disliked=!1,t.dislikes=a.dislikes))}catch(i){console.error("Error liking reply:",i),l.error("点赞失败")}}async function ie(e,t){try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_reply"},body:JSON.stringify({goods_id:d.params.orderId,comment_id:e.id,reply_id:t.id,user_id:d.query.current_user_id})});if(!i.ok)throw new Error("踩失败");const a=await i.json();a.success&&(t.disliked=!t.disliked,t.dislikes=a.dislikes,t.liked&&(t.liked=!1,t.likes=a.likes))}catch(i){console.error("Error disliking reply:",i),l.error("操作失败")}}function F(e){return e.level===2}function Q(e){return e.level===2?`reply_${e.secondary_order_comment_id}`:`comment_${e.order_comment_id}`}function ae(e){const t=Q(e);return v.value.get(t)||null}async function le(e){const t=Q(e),i=F(e)?2:1,a=F(e)?e.secondary_order_comment_id:e.order_comment_id,f=v.value.get(t);if(f==="like"){try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:i,id:a,cancel:!0})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.helpful-=1,v.value.delete(t),l.success("已取消点赞"))}catch(c){console.error("Error handling like:",c),l.error("操作失败，请稍后重试")}return}if(f==="dislike"){l.warning("您已经点过踩了，如需点赞请先取消点踩");return}try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:i,id:a,cancel:!1})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.helpful+=1,v.value.set(t,"like"),l.success("点赞成功"))}catch(c){console.error("Error handling like:",c),l.error("操作失败，请稍后重试")}}async function de(e){const t=Q(e),i=F(e)?2:1,a=F(e)?e.secondary_order_comment_id:e.order_comment_id,f=v.value.get(t);if(f==="dislike"){try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:i,id:a,cancel:!0})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.unhelpful-=1,v.value.delete(t),l.success("已取消点踩"))}catch(c){console.error("Error handling dislike:",c),l.error("操作失败，请稍后重试")}return}if(f==="like"){l.warning("您已经点过赞了，如需点踩请先取消点赞");return}try{const c=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:i,id:a,cancel:!1})});if(!c.ok)throw new Error("Network response was not ok");(await c.json()).success&&(e.unhelpful+=1,v.value.set(t,"dislike"),l.success("点踩成功"))}catch(c){console.error("Error handling dislike:",c),l.error("操作失败，请稍后重试")}}return _e(()=>{document.addEventListener("click",O),P(),K()}),fe(()=>{document.removeEventListener("click",O)}),{goodsDetail:R,orderDetail:r,sellerPicture:N,canRequestRefund:A,confirmDelivery:U,requestRefund:n,getOrderStatusText:u,contactSeller:G,comments:H,newComment:I,submitComment:$,toggleReply:ee,likeComment:te,dislikeComment:re,formatTime:se,likeReply:ne,dislikeReply:ie,base64ToBlob:k,toggleDropdown:B,closeDropdown:O,viewProfile:z,viewNotifications:b,viewMessages:q,contactUs:Y,userAvatar:M,commentActions:v,activeReplyId:T,replyContent:C,getCommentAction:ae,handleLike:le,handleDislike:de,submitReply:oe,commentRating:V}}},ge={class:"order-details-view"},we={class:"header"},be={class:"nav-container"},Ce={class:"user-section"},Se=["src"],Oe={key:0,class:"dropdown-menu"},Te={class:"good-details"},Ee={class:"good-info"},je={class:"good-images"},Re=["src","alt"],Ne={class:"good-details-info"},De={class:"price"},qe={class:"deal-time"},Ae={class:"seller-info"},Pe=["src"],Ue={class:"order-actions"},Ie={class:"order-status"},Ve={class:"good-description"},Fe={class:"comments-section"},xe={class:"comment-input"},Le={class:"rating-section"},Je={class:"comments-list"},Me={class:"comment-main"},Be=["src"],ze={class:"comment-content"},Ye={class:"comment-header"},Ge={class:"comment-user"},He={class:"comment-rating"},Ke={class:"comment-text"},Qe={class:"comment-footer"},We={class:"comment-time"},Xe={class:"comment-actions"},Ze=["onClick"],$e=["onClick"],eo={class:"count"},oo=["onClick"],to={class:"count"},ro={key:0,class:"reply-input-container"},so={class:"reply-actions"},no=["onClick"],io=["onClick"],ao={key:1,class:"reply-list"},lo=["src"],co={class:"comment-content"},uo={class:"comment-user"},_o={class:"comment-text"},fo={class:"comment-footer"},mo={class:"comment-time"},yo={class:"comment-actions"},po=["onClick"],ko={class:"count"},vo=["onClick"],ho={class:"count"};function go(d,s,R,r,N,D){var A,k,P,U;const M=w("Bell"),B=w("el-icon"),O=w("el-carousel-item"),z=w("el-carousel"),b=w("el-button"),q=w("el-rate"),Y=w("el-input");return m(),p("div",ge,[o("header",we,[o("div",be,[s[10]||(s[10]=o("div",{class:"welcome-text"},"欢迎使用二手交易平台",-1)),o("div",Ce,[o("button",{class:"announcement-btn",onClick:s[0]||(s[0]=(...n)=>d.fetchAnnouncements&&d.fetchAnnouncements(...n))},[h(B,null,{default:g(()=>[h(M)]),_:1})]),o("div",{class:"user-profile",onClick:s[6]||(s[6]=me(()=>{},["stop"]))},[o("img",{src:r.userAvatar,alt:"用户头像",class:"avatar",onClick:s[1]||(s[1]=(...n)=>r.toggleDropdown&&r.toggleDropdown(...n))},null,8,Se),d.dropdownVisible?(m(),p("div",Oe,[o("button",{onClick:s[2]||(s[2]=(...n)=>r.viewProfile&&r.viewProfile(...n))},"个人信息"),o("button",{onClick:s[3]||(s[3]=(...n)=>r.viewNotifications&&r.viewNotifications(...n))},"我的通知"),o("button",{onClick:s[4]||(s[4]=(...n)=>r.viewMessages&&r.viewMessages(...n))},"我的消息"),o("button",{onClick:s[5]||(s[5]=(...n)=>r.contactUs&&r.contactUs(...n))},"联系我们")])):j("",!0)])])])]),o("div",Te,[o("div",Ee,[o("div",je,[h(z,{height:"400px"},{default:g(()=>[(m(!0),p(X,null,Z(r.goodsDetail.goods_pictures,(n,u)=>(m(),W(O,{key:u},{default:g(()=>[o("img",{src:n,alt:`商品图片${u+1}`,class:"carousel-image"},null,8,Re)]),_:2},1024))),128))]),_:1})]),o("div",Ne,[o("h1",null,_((A=r.goodsDetail)==null?void 0:A.goods_name),1),o("div",De,"¥"+_((k=r.goodsDetail)==null?void 0:k.goods_price),1),o("div",qe,"下单时间："+_(r.formatTime((P=r.orderDetail)==null?void 0:P.deal_time)),1),o("div",Ae,[o("img",{src:r.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,Pe),h(b,{type:"text",onClick:r.contactSeller},{default:g(()=>s[11]||(s[11]=[L("联系卖家")])),_:1},8,["onClick"])]),o("div",Ue,[o("div",Ie," 订单状态："+_(r.getOrderStatusText(r.orderDetail.order_state)),1),r.orderDetail.order_state==="已下单"?(m(),W(b,{key:0,type:"primary",onClick:r.confirmDelivery},{default:g(()=>s[12]||(s[12]=[L(" 确认送达 ")])),_:1},8,["onClick"])):j("",!0),r.canRequestRefund?(m(),W(b,{key:1,type:"danger",onClick:r.requestRefund},{default:g(()=>s[13]||(s[13]=[L(" 申请退款 ")])),_:1},8,["onClick"])):j("",!0)])])]),o("div",Ve,[s[14]||(s[14]=o("h2",null,"商品描述",-1)),o("p",null,_((U=r.goodsDetail)==null?void 0:U.goods_description),1)]),o("div",Fe,[s[21]||(s[21]=o("h2",null,"评价区",-1)),o("div",xe,[o("div",Le,[s[15]||(s[15]=o("span",{class:"rating-label"},"评分：",-1)),h(q,{modelValue:r.commentRating,"onUpdate:modelValue":s[7]||(s[7]=n=>r.commentRating=n),colors:["#FF9900","#FF9900","#FF9900"],texts:["1星","2星","3星","4星","5星"],"show-text":""},null,8,["modelValue"])]),h(Y,{modelValue:r.newComment,"onUpdate:modelValue":s[8]||(s[8]=n=>r.newComment=n),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),h(b,{type:"primary",onClick:r.submitComment,disabled:!r.newComment.trim()||!r.commentRating},{default:g(()=>s[16]||(s[16]=[L(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),o("div",Je,[(m(!0),p(X,null,Z(r.comments,n=>(m(),p("div",{key:n.order_comment_id,class:"comment-item"},[o("div",Me,[o("img",{src:n.deliver_picture,alt:"用户头像",class:"comment-avatar"},null,8,Be),o("div",ze,[o("div",Ye,[o("div",Ge,_(n.deliver_name),1),o("div",He,[h(q,{modelValue:n.order_grade,"onUpdate:modelValue":u=>n.order_grade=u,disabled:"","show-score":"","text-color":"#ff9900",colors:["#FF9900","#FF9900","#FF9900"]},null,8,["modelValue","onUpdate:modelValue"])])]),o("div",Ke,_(n.comment),1),o("div",Qe,[o("span",We,_(r.formatTime(n.comment_time)),1),o("div",Xe,[o("button",{class:"action-btn reply-btn",onClick:u=>r.toggleReply(n)},_(r.activeReplyId===n.order_comment_id?"取消回复":"回复"),9,Ze),o("button",{class:J(["action-btn like-btn",{active:r.getCommentAction(n)==="like"}]),onClick:u=>r.handleLike(n)},[s[17]||(s[17]=o("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),o("span",eo,_(n.helpful),1)],10,$e),o("button",{class:J(["action-btn dislike-btn",{active:r.getCommentAction(n)==="dislike"}]),onClick:u=>r.handleDislike(n)},[s[18]||(s[18]=o("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),o("span",to,_(n.unhelpful),1)],10,oo)])])])]),r.activeReplyId===n.order_comment_id?(m(),p("div",ro,[pe(o("textarea",{"onUpdate:modelValue":s[9]||(s[9]=u=>r.replyContent=u),placeholder:"写下你的回复...",rows:"2",class:"reply-textarea"},null,512),[[ke,r.replyContent]]),o("div",so,[o("button",{class:"cancel-btn",onClick:u=>r.toggleReply(n)},"取消",8,no),o("button",{class:"submit-btn",onClick:u=>r.submitReply(n.order_comment_id)},"发送",8,io)])])):j("",!0),n.reply&&n.reply.length>0?(m(),p("div",ao,[(m(!0),p(X,null,Z(n.reply,u=>(m(),p("div",{key:u.secondary_order_comment_id,class:"reply-item"},[o("img",{src:u.deliver_picture,alt:"用户头像",class:"comment-avatar"},null,8,lo),o("div",co,[o("div",uo,_(u.deliver_name),1),o("div",_o,_(u.comment),1),o("div",fo,[o("span",mo,_(r.formatTime(u.comment_time)),1),o("div",yo,[o("button",{class:J(["action-btn like-btn",{active:r.getCommentAction(u)==="like"}]),onClick:G=>r.handleLike(u)},[s[19]||(s[19]=o("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),o("span",ko,_(u.helpful),1)],10,po),o("button",{class:J(["action-btn dislike-btn",{active:r.getCommentAction(u)==="dislike"}]),onClick:G=>r.handleDislike(u)},[s[20]||(s[20]=o("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),o("span",ho,_(u.unhelpful),1)],10,vo)])])])]))),128))])):j("",!0)]))),128))])])])])}const bo=ce(he,[["render",go],["__scopeId","data-v-991fb246"]]);export{bo as default};
