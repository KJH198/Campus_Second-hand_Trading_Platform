import{_ as $,r as m,d as h,c as ee,o as te,a as se,b as p,e as t,f as v,w as y,g as M,h as oe,v as re,t as c,i as A,j as I,F as L,k as J,u as ie,E as u,l as g,m as _,n as R,p as T,q as ne}from"./index-CT18r1fy.js";const ae={setup(){const n=ie(),o=ne(),E=m({}),r=m({}),b=m(""),C=m(!1),j=m(n.query.userAvatar||h);function q(){C.value=!C.value}function w(e){e.target.closest(".user-profile")||(C.value=!1)}function D(){o.push({name:"UserProfile",query:{user_id:n.query.current_user_id,current_user_id:n.query.current_user_id,userAvatar:n.query.userAvatar,viewing_own_profile:"true"}})}const k=ee(()=>["已下单","已送达"].includes(r.value.order_state));function f(e){try{const s=atob(e),a=[];for(let d=0;d<s.length;d+=512){const U=s.slice(d,d+512),V=new Array(U.length);for(let O=0;O<U.length;O++)V[O]=U.charCodeAt(O);const Z=new Uint8Array(V);a.push(Z)}return new Blob(a,{type:"image/jpeg"})}catch(s){return console.error("Error converting base64 to Blob:",s),null}}async function i(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:n.params.orderId,user_id:n.query.current_user_id})});if(!e.ok)throw new Error("获取订单详情失败");const s=await e.json();s.success&&(r.value=s.order_detail,E.value={...s.goods_detail,goods_pictures:s.goods_detail.goods_pictures.map(a=>{if(a&&typeof a=="string")try{return URL.createObjectURL(f(a))}catch(d){return console.error("Error converting picture:",d),h}return h})},b.value=s.goods_detail.seller_picture?URL.createObjectURL(f(s.goods_detail.seller_picture)):h)}catch(e){console.error("Error fetching order detail:",e),u.error("获取订单详情失败")}}async function l(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:n.params.orderId,user_id:n.query.current_user_id})});if(!e.ok)throw new Error("确认送达失败");(await e.json()).success&&(u.success("确认送达成功"),r.value.order_state="已送达")}catch(e){console.error("Error confirming delivery:",e),u.error("确认送达失败")}}async function P(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:n.params.orderId,user_id:n.query.current_user_id})});if(!e.ok)throw new Error("申请退款失败");(await e.json()).success&&(u.success("退款申请已提交"),r.value.order_state="已退款")}catch(e){console.error("Error requesting refund:",e),u.error("申请退款失败")}}function x(e){return e||"未知状态"}function F(){o.push({name:"UserProfile",query:{user_id:r.value.seller_id,current_user_id:n.query.current_user_id,userAvatar:b.value,isOwner:!1,viewing_own_profile:"false"}})}const B=m([]),S=m("");async function N(){try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_comments"},body:JSON.stringify({goods_id:n.params.orderId,user_id:n.query.current_user_id})});if(!e.ok)throw new Error("获取评论失败");const s=await e.json();s.success&&(B.value=s.comments.map(a=>({...a,showReply:!1,replyContent:"",user_avatar:a.user_avatar?URL.createObjectURL(f(a.user_avatar)):h,replies:a.replies.map(d=>({...d,user_avatar:d.user_avatar?URL.createObjectURL(f(d.user_avatar)):h}))})))}catch(e){console.error("Error fetching comments:",e),u.error("获取评论失败")}}async function z(){if(S.value.trim())try{const e=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"add_comment"},body:JSON.stringify({goods_id:n.params.orderId,user_id:n.query.current_user_id,content:S.value})});if(!e.ok)throw new Error("发表评论失败");(await e.json()).success&&(u.success("评论发表成功"),S.value="",await N())}catch(e){console.error("Error submitting comment:",e),u.error("评论发表失败")}}function Y(e){e.showReply=!e.showReply}async function G(e){if(e.replyContent.trim())try{const s=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"add_reply"},body:JSON.stringify({goods_id:n.params.orderId,comment_id:e.id,user_id:n.query.current_user_id,content:e.replyContent})});if(!s.ok)throw new Error("回复评论失败");(await s.json()).success&&(u.success("回复成功"),e.replyContent="",e.showReply=!1,await N())}catch(s){console.error("Error submitting reply:",s),u.error("回复失败")}}async function H(e){try{const s=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_comment"},body:JSON.stringify({goods_id:n.params.orderId,comment_id:e.id,user_id:n.query.current_user_id})});if(!s.ok)throw new Error("点赞失败");const a=await s.json();a.success&&(e.liked=!e.liked,e.likes=a.likes,e.disliked&&(e.disliked=!1,e.dislikes=a.dislikes))}catch(s){console.error("Error liking comment:",s),u.error("点赞失败")}}async function K(e){try{const s=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_comment"},body:JSON.stringify({goods_id:n.params.orderId,comment_id:e.id,user_id:n.query.current_user_id})});if(!s.ok)throw new Error("踩失败");const a=await s.json();a.success&&(e.disliked=!e.disliked,e.dislikes=a.dislikes,e.liked&&(e.liked=!1,e.likes=a.likes))}catch(s){console.error("Error disliking comment:",s),u.error("操作失败")}}function Q(e){const s=new Date(e),d=new Date-s;return d<6e4?"刚刚":d<36e5?`${Math.floor(d/6e4)}分钟前`:d<864e5?`${Math.floor(d/36e5)}小时前`:`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`}async function W(e,s){try{const a=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like_reply"},body:JSON.stringify({goods_id:n.params.orderId,comment_id:e.id,reply_id:s.id,user_id:n.query.current_user_id})});if(!a.ok)throw new Error("点赞失败");const d=await a.json();d.success&&(s.liked=!s.liked,s.likes=d.likes,s.disliked&&(s.disliked=!1,s.dislikes=d.dislikes))}catch(a){console.error("Error liking reply:",a),u.error("点赞失败")}}async function X(e,s){try{const a=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"dislike_reply"},body:JSON.stringify({goods_id:n.params.orderId,comment_id:e.id,reply_id:s.id,user_id:n.query.current_user_id})});if(!a.ok)throw new Error("踩失败");const d=await a.json();d.success&&(s.disliked=!s.disliked,s.dislikes=d.dislikes,s.liked&&(s.liked=!1,s.likes=d.likes))}catch(a){console.error("Error disliking reply:",a),u.error("操作失败")}}return te(()=>{document.addEventListener("click",w),i(),N()}),se(()=>{document.removeEventListener("click",w)}),{goodsDetail:E,orderDetail:r,sellerPicture:b,canRequestRefund:k,confirmDelivery:l,requestRefund:P,getOrderStatusText:x,contactSeller:F,comments:B,newComment:S,submitComment:z,toggleReply:Y,submitReply:G,likeComment:H,dislikeComment:K,formatTime:Q,likeReply:W,dislikeReply:X,base64ToBlob:f,toggleDropdown:q,closeDropdown:w,viewProfile:D,userAvatar:j}}},de={class:"order-details-view"},le={class:"header"},ce={class:"nav-container"},ue={class:"user-section"},_e={class:"user-profile"},fe=["src"],me={class:"good-details"},pe={class:"good-info"},ye={class:"good-images"},ke=["src","alt"],he={class:"good-details-info"},ve={class:"price"},ge={class:"deal-time"},we={class:"seller-info"},be=["src"],Ce={class:"order-actions"},Se={class:"order-status"},Oe={class:"good-description"},Re={class:"comments-section"},Te={class:"comment-input"},Ee={class:"comments-list"},je={class:"comment-main"},qe=["src"],De={class:"comment-content"},Pe={class:"comment-user"},Ne={class:"comment-text"},Ue={class:"comment-footer"},Ae={class:"comment-time"},Ie={class:"comment-actions"},Le=["onClick"],Je=["onClick"],Be={class:"count"},Ve=["onClick"],Me={class:"count"},xe={key:0,class:"reply-list"},Fe=["src"],ze={class:"comment-content"},Ye={class:"comment-user"},Ge={class:"comment-text"},He={class:"comment-footer"},Ke={class:"comment-time"},Qe={class:"comment-actions"},We=["onClick"],Xe={class:"count"},Ze=["onClick"],$e={class:"count"};function et(n,o,E,r,b,C){const j=g("Bell"),q=g("el-icon"),w=g("el-carousel-item"),D=g("el-carousel"),k=g("el-button"),f=g("el-input");return _(),p("div",de,[t("header",le,[t("div",ce,[o[8]||(o[8]=t("div",{class:"welcome-text"},"欢迎使用二手交易平台",-1)),t("div",ue,[t("button",{class:"announcement-btn",onClick:o[0]||(o[0]=(...i)=>n.fetchAnnouncements&&n.fetchAnnouncements(...i))},[v(q,null,{default:y(()=>[v(j)]),_:1})]),t("div",_e,[t("img",{src:r.userAvatar,alt:"用户头像",class:"avatar",onClick:o[1]||(o[1]=M((...i)=>r.toggleDropdown&&r.toggleDropdown(...i),["stop"]))},null,8,fe),oe(t("div",{class:"dropdown-menu",onClick:o[6]||(o[6]=M(()=>{},["stop"]))},[t("button",{onClick:o[2]||(o[2]=(...i)=>r.viewProfile&&r.viewProfile(...i))},"个人信息"),t("button",{onClick:o[3]||(o[3]=(...i)=>n.viewNotifications&&n.viewNotifications(...i))},"我的通知"),t("button",{onClick:o[4]||(o[4]=(...i)=>n.viewMessages&&n.viewMessages(...i))},"我的消息"),t("button",{onClick:o[5]||(o[5]=(...i)=>n.contactUs&&n.contactUs(...i))},"联系我们")],512),[[re,n.dropdownVisible]])])])])]),t("div",me,[t("div",pe,[t("div",ye,[v(D,{height:"400px"},{default:y(()=>[(_(!0),p(L,null,J(r.goodsDetail.goods_pictures,(i,l)=>(_(),A(w,{key:l},{default:y(()=>[t("img",{src:i,alt:`商品图片${l+1}`,class:"carousel-image"},null,8,ke)]),_:2},1024))),128))]),_:1})]),t("div",he,[t("h1",null,c(r.goodsDetail.goods_name),1),t("div",ve,"¥"+c(r.goodsDetail.goods_price),1),t("div",ge,"下单时间："+c(r.formatTime(r.orderDetail.deal_time)),1),t("div",we,[t("img",{src:r.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,be),v(k,{type:"text",onClick:r.contactSeller},{default:y(()=>o[9]||(o[9]=[R("联系卖家")])),_:1},8,["onClick"])]),t("div",Ce,[t("div",Se," 订单状态："+c(r.getOrderStatusText(r.orderDetail.order_state)),1),r.orderDetail.order_state==="已下单"?(_(),A(k,{key:0,type:"primary",onClick:r.confirmDelivery},{default:y(()=>o[10]||(o[10]=[R(" 确认送达 ")])),_:1},8,["onClick"])):I("",!0),r.canRequestRefund?(_(),A(k,{key:1,type:"danger",onClick:r.requestRefund},{default:y(()=>o[11]||(o[11]=[R(" 申请退款 ")])),_:1},8,["onClick"])):I("",!0)])])]),t("div",Oe,[o[12]||(o[12]=t("h2",null,"商品描述",-1)),t("p",null,c(r.goodsDetail.goods_description),1)]),t("div",Re,[o[18]||(o[18]=t("h2",null,"评价区",-1)),t("div",Te,[v(f,{modelValue:r.newComment,"onUpdate:modelValue":o[7]||(o[7]=i=>r.newComment=i),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),v(k,{type:"primary",onClick:r.submitComment,disabled:!r.newComment.trim()},{default:y(()=>o[13]||(o[13]=[R(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),t("div",Ee,[(_(!0),p(L,null,J(r.comments,i=>(_(),p("div",{key:i.id,class:"comment-item"},[t("div",je,[t("img",{src:i.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,qe),t("div",De,[t("div",Pe,c(i.username),1),t("div",Ne,c(i.content),1),t("div",Ue,[t("span",Ae,c(r.formatTime(i.create_time)),1),t("div",Ie,[t("button",{class:"action-btn reply-btn",onClick:l=>r.toggleReply(i)},c(i.showReply?"取消回复":"回复"),9,Le),t("button",{class:T(["action-btn like-btn",{active:i.liked}]),onClick:l=>r.likeComment(i)},[o[14]||(o[14]=t("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),t("span",Be,c(i.likes),1)],10,Je),t("button",{class:T(["action-btn dislike-btn",{active:i.disliked}]),onClick:l=>r.dislikeComment(i)},[o[15]||(o[15]=t("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),t("span",Me,c(i.dislikes),1)],10,Ve)])])])]),i.replies&&i.replies.length>0?(_(),p("div",xe,[(_(!0),p(L,null,J(i.replies,l=>(_(),p("div",{key:l.id,class:"reply-item"},[t("img",{src:l.user_avatar,alt:"用户头像",class:"comment-avatar"},null,8,Fe),t("div",ze,[t("div",Ye,c(l.username),1),t("div",Ge,c(l.content),1),t("div",He,[t("span",Ke,c(r.formatTime(l.create_time)),1),t("div",Qe,[t("button",{class:T(["action-btn like-btn",{active:l.liked}]),onClick:P=>r.likeReply(i,l)},[o[16]||(o[16]=t("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),t("span",Xe,c(l.likes),1)],10,We),t("button",{class:T(["action-btn dislike-btn",{active:l.disliked}]),onClick:P=>r.dislikeReply(i,l)},[o[17]||(o[17]=t("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),t("span",$e,c(l.dislikes),1)],10,Ze)])])])]))),128))])):I("",!0)]))),128))])])])])}const st=$(ae,[["render",et],["__scopeId","data-v-d34dea2f"]]);export{st as default};
