import{_ as ie,r as v,d as S,c as ae,o as le,a as ce,b as p,e,f as h,w,g as de,h as R,t as _,i as W,F as X,j as Z,u as ue,E as c,k,l as f,m as L,n as M,p as _e,v as me,q as fe}from"./index-CTNilYOx.js";const ve={setup(){const d=ue(),r=fe(),j=v({}),t=v({}),D=v(""),A=v(!1),J=v(d.query.userAvatar||S);function B(o){o.stopPropagation(),A.value=!A.value}function O(o){o.target.closest(".user-profile")||(A.value=!1)}function z(){r.push({name:"UserProfile",query:{user_id:d.query.current_user_id,current_user_id:d.query.current_user_id,userAvatar:d.query.userAvatar,viewing_own_profile:"true"}})}function b(){console.log("查看通知")}function N(){console.log("查看消息")}function Y(){console.log("联系我们")}const q=ae(()=>["已下单","已送达"].includes(t.value.order_state));function g(o){try{const s=atob(o),u=[];for(let l=0;l<s.length;l+=512){const m=s.slice(l,l+512),i=new Array(m.length);for(let I=0;I<m.length;I++)i[I]=m.charCodeAt(I);const E=new Uint8Array(i);u.push(E)}return new Blob(u,{type:"image/jpeg"})}catch(s){return console.error("Error converting base64 to Blob:",s),null}}async function P(){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"get_order_detail"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!o.ok)throw new Error("获取订单详情失败");const s=await o.json();console.log(s),s.success&&(t.value=s.order_detail,console.log(t.value),j.value={...s.goods_detail,goods_pictures:s.goods_detail.goods_pictures.map(u=>{if(u&&typeof u=="string")try{return URL.createObjectURL(g(u))}catch(l){return console.error("Error converting picture:",l),S}return S})},D.value=s.goods_detail.seller_picture?URL.createObjectURL(g(s.goods_detail.seller_picture)):S)}catch(o){console.error("Error fetching order detail:",o),c.error("获取订单详情失败")}}async function U(){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"confirm_delivery"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!o.ok)throw new Error("确认送达失败");(await o.json()).success&&(c.success("确认送达成功"),t.value.order_state="已送达")}catch(o){console.error("Error confirming delivery:",o),c.error("确认送达失败")}}async function n(){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"request_refund"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!o.ok)throw new Error("申请退款失败");(await o.json()).success&&(c.success("退款申请已提交"),t.value.order_state="已退款")}catch(o){console.error("Error requesting refund:",o),c.error("申请退款失败")}}function a(o){return o||"未知状态"}function G(){r.push({name:"UserProfile",query:{user_id:j.value.seller_id,current_user_id:d.query.current_user_id,userAvatar:D.value,isOwner:!1,viewing_own_profile:"false"}})}const H=v([]),V=v(""),y=v(new Map),T=v(null),C=v(""),F=v(0);async function K(){try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"comments"},body:JSON.stringify({goods_id:d.params.orderId,user_id:d.query.current_user_id})});if(!o.ok)throw new Error("Failed to fetch comments");const u=(await o.json()).map(l=>{const m={...l,level:1,deliver_picture:l.picture?URL.createObjectURL(g(l.picture)):S};return l.reply&&Array.isArray(l.reply)&&(m.reply=l.reply.map(i=>({...i,level:2,deliver_picture:i.picture?URL.createObjectURL(g(i.picture)):S}))),m});H.value=u,console.log("评论列表：",H.value)}catch(o){console.error("Error fetching comments:",o),c.error("获取评论失败")}}async function $(){if(!V.value.trim()){c.warning("评论内容不能为空");return}if(!F.value){c.warning("请给出评分");return}try{const o=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_comment"},body:JSON.stringify({goods_id:d.params.orderId,comment:V.value,deliver_id:d.query.current_user_id,order_grade:F.value})});if(!o.ok)throw new Error("Network response was not ok");(await o.json()).success?(c.success("评论发表成功！"),await K(),V.value="",F.value=0):c.error("评论发表失败，请重试")}catch(o){console.error("Error submitting comment:",o),c.error("评论发表失败，请稍后重试")}}function ee(o){T.value===o.order_comment_id?(T.value=null,C.value=""):(T.value=o.order_comment_id,C.value="")}async function oe(o){if(!C.value.trim()){c.warning("回复内容不能为空");return}try{const s=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"commit_reply"},body:JSON.stringify({order_comment_id:o,comment:C.value,deliver_id:d.query.current_user_id})});if(!s.ok)throw new Error("Network response was not ok");(await s.json()).success?(c.success("回复成功"),C.value="",T.value=null,await K()):c.error("回复失败，请重试")}catch(s){console.error("Error submitting reply:",s),c.error("回复失败，请稍后重试")}}function te(o){if(!o)return"暂无时间信息";try{const s=new Date(o),l=new Date-s;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分钟前`:l<864e5?`${Math.floor(l/36e5)}小时前`:`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`}catch(s){return console.error("Error formatting time:",s),"时间格式错误"}}function x(o){return o.level===2}function Q(o){return o.level===2?`reply_${o.secondary_order_comment_id}`:`comment_${o.order_comment_id}`}function re(o){const s=Q(o);return y.value.get(s)||null}async function ne(o){const s=Q(o),u=x(o)?2:1,l=x(o)?o.secondary_order_comment_id:o.order_comment_id,m=y.value.get(s);if(m==="like"){try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:u,id:l,cancel:!0})});if(!i.ok)throw new Error("Network response was not ok");(await i.json()).success&&(o.helpful-=1,y.value.delete(s),c.success("已取消点赞"))}catch(i){console.error("Error handling like:",i),c.error("操作失败，请稍后重试")}return}if(m==="dislike"){c.warning("您已经点过踩了，如需点赞请先取消点踩");return}try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!0,level:u,id:l,cancel:!1})});if(!i.ok)throw new Error("Network response was not ok");(await i.json()).success&&(o.helpful+=1,y.value.set(s,"like"),c.success("点赞成功"))}catch(i){console.error("Error handling like:",i),c.error("操作失败，请稍后重试")}}async function se(o){const s=Q(o),u=x(o)?2:1,l=x(o)?o.secondary_order_comment_id:o.order_comment_id,m=y.value.get(s);if(m==="dislike"){try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:u,id:l,cancel:!0})});if(!i.ok)throw new Error("Network response was not ok");(await i.json()).success&&(o.unhelpful-=1,y.value.delete(s),c.success("已取消点踩"))}catch(i){console.error("Error handling dislike:",i),c.error("操作失败，请稍后重试")}return}if(m==="like"){c.warning("您已经点过赞了，如需点踩请先取消点赞");return}try{const i=await fetch("/order_detail",{method:"POST",headers:{"Content-Type":"application/json",type:"like"},body:JSON.stringify({like:!1,level:u,id:l,cancel:!1})});if(!i.ok)throw new Error("Network response was not ok");(await i.json()).success&&(o.unhelpful+=1,y.value.set(s,"dislike"),c.success("点踩成功"))}catch(i){console.error("Error handling dislike:",i),c.error("操作失败，请稍后重试")}}return le(()=>{document.addEventListener("click",O),P(),K()}),ce(()=>{document.removeEventListener("click",O)}),{goodsDetail:j,orderDetail:t,sellerPicture:D,canRequestRefund:q,confirmDelivery:U,requestRefund:n,getOrderStatusText:a,contactSeller:G,comments:H,newComment:V,submitComment:$,toggleReply:ee,formatTime:te,base64ToBlob:g,toggleDropdown:B,closeDropdown:O,viewProfile:z,viewNotifications:b,viewMessages:N,contactUs:Y,userAvatar:J,commentActions:y,activeReplyId:T,replyContent:C,getCommentAction:re,handleLike:ne,handleDislike:se,submitReply:oe,commentRating:F}}},pe={class:"order-details-view"},ge={class:"header"},ye={class:"nav-container"},he={class:"user-section"},we=["src"],ke={key:0,class:"dropdown-menu"},be={class:"good-details"},Ce={class:"good-info"},Se={class:"good-images"},Oe=["src","alt"],Te={class:"good-details-info"},Ee={class:"price"},Re={class:"deal-time"},je={class:"seller-info"},De=["src"],Ae={class:"order-actions"},Ne={class:"order-status"},qe={class:"good-description"},Pe={class:"comments-section"},Ue={class:"comment-input"},Ve={class:"rating-section"},Fe={class:"comments-list"},xe={class:"comment-main"},Ie=["src"],Le={class:"comment-content"},Me={class:"comment-header"},Je={class:"comment-user"},Be={class:"comment-rating"},ze={class:"comment-text"},Ye={class:"comment-footer"},Ge={class:"comment-time"},He={class:"comment-actions"},Ke=["onClick"],Qe=["onClick"],We={class:"count"},Xe=["onClick"],Ze={class:"count"},$e={key:0,class:"reply-input-container"},eo={class:"reply-actions"},oo=["onClick"],to=["onClick"],ro={key:1,class:"reply-list"},no=["src"],so={class:"comment-content"},io={class:"comment-user"},ao={class:"comment-text"},lo={class:"comment-footer"},co={class:"comment-time"},uo={class:"comment-actions"},_o=["onClick"],mo={class:"count"},fo=["onClick"],vo={class:"count"};function po(d,r,j,t,D,A){var q,g,P,U;const J=k("Bell"),B=k("el-icon"),O=k("el-carousel-item"),z=k("el-carousel"),b=k("el-button"),N=k("el-rate"),Y=k("el-input");return f(),p("div",pe,[e("header",ge,[e("div",ye,[r[10]||(r[10]=e("div",{class:"welcome-text"},"欢迎使用二手交易平台",-1)),e("div",he,[e("button",{class:"announcement-btn",onClick:r[0]||(r[0]=(...n)=>d.fetchAnnouncements&&d.fetchAnnouncements(...n))},[h(B,null,{default:w(()=>[h(J)]),_:1})]),e("div",{class:"user-profile",onClick:r[6]||(r[6]=de(()=>{},["stop"]))},[e("img",{src:t.userAvatar,alt:"用户头像",class:"avatar",onClick:r[1]||(r[1]=(...n)=>t.toggleDropdown&&t.toggleDropdown(...n))},null,8,we),d.dropdownVisible?(f(),p("div",ke,[e("button",{onClick:r[2]||(r[2]=(...n)=>t.viewProfile&&t.viewProfile(...n))},"个人信息"),e("button",{onClick:r[3]||(r[3]=(...n)=>t.viewNotifications&&t.viewNotifications(...n))},"我的通知"),e("button",{onClick:r[4]||(r[4]=(...n)=>t.viewMessages&&t.viewMessages(...n))},"我的消息"),e("button",{onClick:r[5]||(r[5]=(...n)=>t.contactUs&&t.contactUs(...n))},"联系我们")])):R("",!0)])])])]),e("div",be,[e("div",Ce,[e("div",Se,[h(z,{height:"400px"},{default:w(()=>[(f(!0),p(X,null,Z(t.goodsDetail.goods_pictures,(n,a)=>(f(),W(O,{key:a},{default:w(()=>[e("img",{src:n,alt:`商品图片${a+1}`,class:"carousel-image"},null,8,Oe)]),_:2},1024))),128))]),_:1})]),e("div",Te,[e("h1",null,_((q=t.goodsDetail)==null?void 0:q.goods_name),1),e("div",Ee,"¥"+_((g=t.goodsDetail)==null?void 0:g.goods_price),1),e("div",Re,"下单时间："+_(t.formatTime((P=t.orderDetail)==null?void 0:P.deal_time)),1),e("div",je,[e("img",{src:t.sellerPicture,alt:"卖家头像",class:"seller-avatar"},null,8,De),h(b,{type:"text",onClick:t.contactSeller},{default:w(()=>r[11]||(r[11]=[L("联系卖家")])),_:1},8,["onClick"])]),e("div",Ae,[e("div",Ne," 订单状态："+_(t.getOrderStatusText(t.orderDetail.order_state)),1),t.orderDetail.order_state==="已下单"?(f(),W(b,{key:0,type:"primary",onClick:t.confirmDelivery},{default:w(()=>r[12]||(r[12]=[L(" 确认送达 ")])),_:1},8,["onClick"])):R("",!0),t.canRequestRefund?(f(),W(b,{key:1,type:"danger",onClick:t.requestRefund},{default:w(()=>r[13]||(r[13]=[L(" 申请退款 ")])),_:1},8,["onClick"])):R("",!0)])])]),e("div",qe,[r[14]||(r[14]=e("h2",null,"商品描述",-1)),e("p",null,_((U=t.goodsDetail)==null?void 0:U.goods_description),1)]),e("div",Pe,[r[21]||(r[21]=e("h2",null,"评价区",-1)),e("div",Ue,[e("div",Ve,[r[15]||(r[15]=e("span",{class:"rating-label"},"评分：",-1)),h(N,{modelValue:t.commentRating,"onUpdate:modelValue":r[7]||(r[7]=n=>t.commentRating=n),colors:["#FF9900","#FF9900","#FF9900"],texts:["1星","2星","3星","4星","5星"],"show-text":""},null,8,["modelValue"])]),h(Y,{modelValue:t.newComment,"onUpdate:modelValue":r[8]||(r[8]=n=>t.newComment=n),type:"textarea",rows:3,placeholder:"说说你的想法..."},null,8,["modelValue"]),h(b,{type:"primary",onClick:t.submitComment,disabled:!t.newComment.trim()||!t.commentRating},{default:w(()=>r[16]||(r[16]=[L(" 发表评论 ")])),_:1},8,["onClick","disabled"])]),e("div",Fe,[(f(!0),p(X,null,Z(t.comments,n=>(f(),p("div",{key:n.order_comment_id,class:"comment-item"},[e("div",xe,[e("img",{src:n.deliver_picture,alt:"用户头像",class:"comment-avatar"},null,8,Ie),e("div",Le,[e("div",Me,[e("div",Je,_(n.deliver_name),1),e("div",Be,[h(N,{modelValue:n.order_grade,"onUpdate:modelValue":a=>n.order_grade=a,disabled:"","show-score":"","text-color":"#ff9900",colors:["#FF9900","#FF9900","#FF9900"]},null,8,["modelValue","onUpdate:modelValue"])])]),e("div",ze,_(n.comment),1),e("div",Ye,[e("span",Ge,_(t.formatTime(n.comment_time)),1),e("div",He,[e("button",{class:"action-btn reply-btn",onClick:a=>t.toggleReply(n)},_(t.activeReplyId===n.order_comment_id?"取消回复":"回复"),9,Ke),e("button",{class:M(["action-btn like-btn",{active:t.getCommentAction(n)==="like"}]),onClick:a=>t.handleLike(n)},[r[17]||(r[17]=e("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),e("span",We,_(n.helpful),1)],10,Qe),e("button",{class:M(["action-btn dislike-btn",{active:t.getCommentAction(n)==="dislike"}]),onClick:a=>t.handleDislike(n)},[r[18]||(r[18]=e("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),e("span",Ze,_(n.unhelpful),1)],10,Xe)])])])]),t.activeReplyId===n.order_comment_id?(f(),p("div",$e,[_e(e("textarea",{"onUpdate:modelValue":r[9]||(r[9]=a=>t.replyContent=a),placeholder:"写下你的回复...",rows:"2",class:"reply-textarea"},null,512),[[me,t.replyContent]]),e("div",eo,[e("button",{class:"cancel-btn",onClick:a=>t.toggleReply(n)},"取消",8,oo),e("button",{class:"submit-btn",onClick:a=>t.submitReply(n.order_comment_id)},"发送",8,to)])])):R("",!0),n.reply&&n.reply.length>0?(f(),p("div",ro,[(f(!0),p(X,null,Z(n.reply,a=>(f(),p("div",{key:a.secondary_order_comment_id,class:"reply-item"},[e("img",{src:a.deliver_picture,alt:"用户头像",class:"comment-avatar"},null,8,no),e("div",so,[e("div",io,_(a.deliver_name),1),e("div",ao,_(a.comment),1),e("div",lo,[e("span",co,_(t.formatTime(a.comment_time)),1),e("div",uo,[e("button",{class:M(["action-btn like-btn",{active:t.getCommentAction(a)==="like"}]),onClick:G=>t.handleLike(a)},[r[19]||(r[19]=e("i",{class:"fas fa-thumbs-up thumb-icon"},null,-1)),e("span",mo,_(a.helpful),1)],10,_o),e("button",{class:M(["action-btn dislike-btn",{active:t.getCommentAction(a)==="dislike"}]),onClick:G=>t.handleDislike(a)},[r[20]||(r[20]=e("i",{class:"fas fa-thumbs-down thumb-icon"},null,-1)),e("span",vo,_(a.unhelpful),1)],10,fo)])])])]))),128))])):R("",!0)]))),128))])])])])}const yo=ie(ve,[["render",po],["__scopeId","data-v-a69704ac"]]);export{yo as default};
